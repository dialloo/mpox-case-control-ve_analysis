---
title: "2022 Mpox Multi-Jurisdictional Case-Control VE Public Health Evaluation"
subtitle: "Data Quality Checks & Preliminary Report"
authors: "Report by Case-Control Unit | VE Team | VTF | 2022 Multinational Monkeypox Response"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output:
  html_document:
    code_folding: hide
    highlight: tango
    toc: yes
    toc_depth: 3
    toc_float: yes
    editor_options:
      chunk_output_type: console
      canonical: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Study objectives

**Primary:** Evaluate the effectiveness of the JYNNEOS vaccine in preventing symptomatic mpox disease among 18-49-year-old gay, bisexual, and other men who have sex with men, as well as transgender, non-binary, and gender-diverse persons.

**Secondary:** Estimate effectiveness by number of doses, route of administration and age group (if samples size allows).

## Resources:

-   Rmarkdown:

    -   [R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook/) (AOD: if you are familiar with R Markdown, then this is more digestible.)

    -   [Write Markdown in the RStudio Visual Editor](https://bookdown.org/yihui/rmarkdown-cookbook/rstudio-visual.html) (AOD: this is amazing!)

    -   [The Definitive Guide](https://bookdown.org/yihui/rmarkdown/)

```{r libraries, message = FALSE, warning = FALSE}

# Data in: Pulled data directly from REDCap using API token
# Initial program date: 2022-12-15
# Last modified date: 2022-12-19

# Load packages --------------------------------
  pacman::p_load(here,         # file paths relative to R project root folder
                 tidyverse,    # data management and visualization
                 purrr,        # iteration
                 janitor,      # data management: cleaning and exploring data
                 lubridate,    # working with dates/epiweeks
                 naniar,       # Working with data structures, summaries, and visualizations for Missing Data
                 arsenal,      # provides unctions for large-scale statistical summaries
                 ggsci,        # scientific journal and sci-fi themed color palettes for 'ggplot2'
                 cowplot,      # streamlined plot theme and plot annotations for 'ggplot2'
                 knitr,        # Provides a general-purpose tool for dynamic report generation in R
                 kableExtra,   # simplifies the way to manipulate the HTML or 'LaTeX' codes generated by 'kable()
                 DT,           # provides an R interface to the JavaScript library DataTables
                 gtsummary,    # publication-ready analytical and summary tables
                 stargazer,    # provides a way to create publication quality tables
                 plotly        # creates interactive web-based graphs 

                 
  )

# Global option number format
  options(scipen = 9999)

# Helper (custom functions) ------------------------------------------------------------
#This function replicates the SAS proc freq function with the '/ list missing statement'. 
#Source: https://github.com/asnr/sas-to-r
pfreq = function(...) {
  dplyr::group_by(...) %>%
    dplyr::summarize(n = n()) %>%
    dplyr::mutate(pct= round(100 * n/sum(n), 1)) 
  #mutate(Percent=paste0(round(100 * n/sum(n), 1), "%")) 
}

# This function generates summary stats of continues vars.
# Source: https://www.r4epi.com/writing-functions.html
  continuous_stats <- function(dta, var) {
    dta %>% 
      summarise(
        n_miss = sum(is.na({{ var }})),
        mean   = mean({{ var }}, na.rm = TRUE),
        median = median({{ var }}, na.rm = TRUE),
        min    = min({{ var }}, na.rm = TRUE),
        max    = max({{ var }}, na.rm = TRUE)
      )
    }
  
# This function helps create consistent values for Yes/No variables.
# by reassigning '2' values a zero. 
give_two_a_zero <- function(x){
  x[x == 2 ] <- 0
  x
}


# Source data and create ---------------------------------------------------------------------

  source("00_REDCap-API-linkage.R", local =knit_global())


  # This the date of the earliest symptom per the study protocol, 
  # but there is flexibility around this date to account for recall bias.
  earliest_symp_date <- ymd("2022-08-19")

  # This date represent the most recent data transfer from jurisdictions
  date_tag <- ymd("2022-12-16")
  
  

# Tidy data ----------------------------------------------------------------------
mpoxve <- raw %>%
    # Restrict to eligible participants (i.e., those that passed the eligibility screening)
    filter(inelig_stop ==  1) %>% 
    mutate(# Format all yes/no variables with 1(Yes)/2(No) values as 1(Yes)/0(No).
           across(contains(c("elig_age", "elig_gender_msm", "elig_sexual_partners",
                             "elig_healthcare", "first_dose_yesno", "second_dose_yesno",
                             "symptoms_yesno", "provider_dx", "clinic_yesno", "hospitalized",
                             "dose1_yesno", "dose2_yesno"), ignore.case = TRUE), give_two_a_zero),
           
           
           # Format all date variables as YYYY-MM-DD
           across(contains("_date", ignore.case = TRUE), ymd),
           # Check the presence of a jurisdiction ID
           juris_detect = case_when(str_detect(pid, "CA_|CO_| CT_|DC_|GA_|LAC_|MD_|MN_|NYC_|NYS_|OR_|TN_") ~ 1,
                           TRUE ~ as.numeric(0)),
             #! On 2022-12-19, there was 9 records (1 in GA [#59] & 8 in TN) without a jurisdiction ID,
             #                 Oumar contacted TN in early December and GA on 2022-12-19 to append ID the next they share data.
             #                 NYC also experienced this issue have not uploaded data yet. TN has already addressed the issue.
             #                 Oumar shared TN's solution with GA and NYC. Before deleting records missing the TN code, Oumar 
             #                 archived the data here: 
             #                 (Case Control > Data management and analysis > data_archive > MultiJurisdictionalM_DATA_2022-12-19_1108). 
           
           # Rename REDCap Data Access Group variable and capitalize the letters
           jid = toupper(redcap_data_access_group),
           
           # Case Ascertainment: Symptomatic cases identified by state or local health departments who meet either
           #                     the confirmed or probable case definition will be eligible for inclusion. 
           #                     #! If a participant self-reports as a cases and the rest of their data
           #                        are consistent with being a case then we should follow-up with the
           #                        with he jurisdiction to confirm. We will likely include this participant as a case.
           
           
           # Create indicator vars to help flag records missing minimum set of data elements need for VE  variables
          
           provider_dx_na = case_when(is.na(provider_dx) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           symptoms_yesno_na = case_when(is.na(symptoms_yesno) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           symptoms_date_na = case_when(symptoms_yesno == 1 & is.na(symptoms_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           clinic_yesno_na = case_when((provider_dx == 0 | is.na(provider_dx)) & is.na(clinic_yesno) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           clinic_date_na = case_when(clinic_yesno == 1 & is.na(clinic_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           first_dose_yesno_na = case_when(is.na(first_dose_yesno) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           first_dose_date_na = case_when(first_dose_yesno == 1 & is.na(first_dose_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           second_dose_yesno_na = case_when(first_dose_yesno == 1 & is.na(second_dose_yesno) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           second_dose_date_na = case_when(second_dose_yesno == 1 & is.na(second_dose_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           # Flag records missing any minimum set of data element need for VE  variables
           minset_vars = ifelse(if_any(contains("_na"), ~ . == 1), 0, 1),
           
           # Flag those who reported having experienced mpox symptoms and specified one of the listed symptoms 
           symptom_type_complete = ifelse(symptoms_yesno == 1 &
                                               if_any(contains("symptom_type___"), ~ . == 1),
                                             1,
                                             ifelse(symptoms_yesno == 1 &
                                                       if_all(contains("symptom_type___"), ~ . == 0),
                                                     0, NA)),
             
           # Create variable for case/control classification by site-report and self-report for consistency checks.
           # The site report maybe missing because of data entry delay
           ca_co_check = fct_relevel(as_factor(case_when(case_yesno %in% c(1,2) & provider_dx == 1 ~ "Case: site & self",
                                                   is.na(case_yesno)  & provider_dx == 1 ~ "Case: self but site missing",
                                                   case_yesno == 3 & provider_dx == 0 ~ "Control: site & self",
                                                   is.na(case_yesno)  & provider_dx == 0 ~ "Control: self but site missing",
                                                   case_yesno %in% c(1,2) & provider_dx == 0 ~ "Discrepancy: site case",
                                                   case_yesno == 3 & provider_dx == 1 ~ "Discrepancy: self case",
                                                   TRUE ~ as.character(NA))),
                              "Case: site & self", "Case: self but site missing",
                              "Control: site & self", "Control: self but site missing",
                              "Discrepancy: site case", "Discrepancy: self case"),
           
           # Flag cases with/without symptoms; Everyone who said that they had mpox symptoms, specified at least one of the options.
           ca_co_symp = fct_relevel(as_factor(case_when(ca_co_check %in% c("Case: site & self", "Case: self but site missing") &
                                                          symptoms_yesno == 1  ~ "Case: symptom +",
                                                        ca_co_check %in% c("Case: self & site", "Case: self but site missing") &
                                                          symptoms_yesno == 0  ~ "Case: symptom -",
                                                        ca_co_check %in% c("Control: site & self", "Control: self but site missing") ~
                                                          "Control",
                                                TRUE ~ as.character(NA))),
                                    "Case: symptom +", "Case: symptom -",
                                    "Control"),
           
           ca_co = fct_relevel(as_factor(case_when(case_yesno %in% c(1,2) & symptoms_yesno == 1  ~ "Case",
                                                   case_yesno == 3 ~ "Control",
                                                   TRUE ~ as.character(NA))),
                               "Case", "Control"),
           # Flag mpox symptoms date within 2022-08-19 and system date. 
           timepoint_interval = interval(earliest_symp_date, date_tag),
           
           
           symp_clinic_site_date_met = case_when((symptoms_date %within% timepoint_interval) |
                                                   (control_visit_date %within% timepoint_interval) ~ 1,
                                                 ((symptoms_date < earliest_symp_date | 
                                                   control_visit_date < earliest_symp_date) |
                                                   (symptoms_date > date_tag | 
                                                      control_visit_date > date_tag)) ~ 0,
                                            TRUE ~ as.numeric(NA)),
           
           symp_clinic_self_date_met = case_when((symptoms_date %within% timepoint_interval) |
                                                   (clinic_date %within% timepoint_interval) ~ 1,
                                                 ((symptoms_date < earliest_symp_date | 
                                                   clinic_date < earliest_symp_date) |
                                                   (symptoms_date > date_tag | 
                                                      clinic_date > date_tag)) ~ 0,
                                            TRUE ~ as.numeric(NA)),
           
           # Calculate age based on birth year and symptom or clinic date
            age = ifelse(ca_co == "Case", (year(symptoms_date) - birth_year),
                         ifelse(ca_co == "Control", (year(control_visit_date) - birth_year), NA))
            ) %>% 
  select(pid, jid, everything(), -redcap_data_access_group) 

# %>% 
#   filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN),
#          (is.na(ca_co_check) | minset_vars == 0) == F)

tt <- mpoxve %>%
  select(pid, ca_co_check,
         provider_dx, clinic_yesno, clinic_date,
         symptoms_yesno, symptoms_date,
         first_dose_yesno, first_dose_date,
         second_dose_yesno, second_dose_date
         ) 

aa <- mpoxve %>% pfreq(minset_vars, provider_dx_na, clinic_yesno_na, clinic_date_na,
                       symptoms_yesno_na, symptoms_date_na,
                       first_dose_yesno_na, first_dose_date_na,
                       second_dose_yesno_na, second_dose_date_na)

bb <- mpoxve %>% 
  filter(!is.na(ca_co))%>% 
  pfreq(ca_co, symp_clinic_site_date_met, symp_clinic_self_date_met,
        symptoms_date, test_result_date, control_visit_date, clinic_date) %>% 
  filter(symp_clinic_site_date_met == 0 |  symp_clinic_self_date_met == 0)

# gg_miss_upset(tt)

ss <- mpoxve %>% pfreq(clinic_yesno_na, provider_dx, clinic_yesno)

```

## Data Quality Check

##### Distribution of case status

```{r}
mpoxve %>% 
  filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN),
         (is.na(ca_co_check) | minset_vars == 0) == F) %>%
  select(jid, ca_co_check, ca_co_symp, ca_co) %>% 
  tbl_summary(
    by = jid,
    label = list(ca_co_check ~ "Case status (site & self)",
                 ca_co_symp ~ "Case status + symptom",
                 ca_co ~ "Case status per protocol"),
     #percent = "column",
    missing = "always",
    missing_text = "Missing"
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()
```

##### Distribution of case status within timepoint interval (matching criteria): `r earliest_symp_date` -- `r date_tag` 

```{r}
int_date_met <- mpoxve %>% 
  filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN),
         (is.na(ca_co_check) | minset_vars == 0) == F) %>%
  filter(is.na(ca_co) == F) %>% # restrict to per protocol definition of case status
  filter(symp_clinic_site_date_met == 0 | symp_clinic_self_date_met == 0) %>% # restrict to those without any date met
  pfreq(ca_co, symptoms_date, test_result_date, control_visit_date, clinic_date) %>% 
  select(-n, -pct)

kable(int_date_met)
  

tt <- mpoxve %>% 
  filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN),
         (is.na(ca_co_check) | minset_vars == 0) == F) %>%
  pfreq(jid, birth_year)
```
