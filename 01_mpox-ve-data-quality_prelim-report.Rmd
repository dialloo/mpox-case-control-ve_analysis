---
title: "Data Quality Report" 
subtitle: "2022 Mpox Multi-Jurisdictional Case-Control VE Public Health Evaluation"
author: "Report by Case-Control Unit | VE Team | VTF | 2022 Multinational Monkeypox Response"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
  # html_document:
    code_folding: hide
    highlight: tango
    #toc: yes
    toc_depth: 3
    #toc_float: yes
    editor_options:
      chunk_output_type: console
      canonical: true
      
    # word_document:
    # reference_docx: "template.docx"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## **Report objective**

Examine data quality, clean data, and create analysis variables.

```{r libraries, message = FALSE, warning = FALSE}

# Data in: Pulled data directly from REDCap using API token
# Initial program date: 2022-12-15
# Last modified date: 2023-01-20

# Load packages --------------------------------
  pacman::p_load(here,        # file paths relative to R project root folder
                 rio,         # import/export
                 readxl,      # read excel files
                 tidyverse,    # data management and visualization
                 purrr,        # iteration
                 janitor,      # data management: cleaning and exploring data
                 lubridate,    # working with dates/epiweeks
                 naniar,       # Working with data structures, summaries, and visualizations for Missing Data
                 arsenal,      # provides unctions for large-scale statistical summaries
                 ggsci,        # scientific journal and sci-fi themed color palettes for 'ggplot2'
                 cowplot,      # streamlined plot theme and plot annotations for 'ggplot2'
                 knitr,        # Provides a general-purpose tool for dynamic report generation in R
                 kableExtra,   # simplifies the way to manipulate the HTML or 'LaTeX' codes generated by 'kable()
                 DT,           # provides an R interface to the JavaScript library DataTables
                 gtsummary,    # publication-ready analytical and summary tables
                 stargazer,    # provides a way to create publication quality tables
                 plotly        # creates interactive web-based graphs 

                 
  )

# Global option number format
  options(scipen = 9999)

#GT Table Theme
  theme_gtsummary_journal(journal = "jama")
  theme_gtsummary_compact()
# Helper (custom functions) ------------------------------------------------------------
#This function replicates the SAS proc freq function with the '/ list missing statement'. 
#Source: https://github.com/asnr/sas-to-r
pfreq = function(...) {
  dplyr::group_by(...) %>%
    dplyr::summarize(n = n()) %>%
    dplyr::mutate(pct= round(100 * n/sum(n), 1)) 
  #mutate(Percent=paste0(round(100 * n/sum(n), 1), "%")) 
}

# This function helps create consistent values for Yes/No variables.
# by reassigning '2' values a zero. 
give_two_a_zero <- function(x){
  x[x == 2 ] <- 0
  x
}


# Source data and define environment variables ---------------------------------------------------------------------

  #source("00_REDCap-API-linkage.R", local =knit_global())
  
  raw <- here("data", "MultiJurisdictionalM_DATA_2023-01-21_2201.csv") %>% 
  read_csv()

  # This the date of the earliest symptom per the study protocol, 
  # but there is flexibility around this date to account for recall bias.
  
  eligibility_date_v2 <- "19 Aug 2022"

  # This date represent the most recent data transfer from jurisdictions
  
  redcap_trans_date_v2 <- "20 Jan 2023"

# transform data > run r script > 
# Tidy data ----------------------------------------------------------------------
mpoxve <- raw %>%
    # Restrict to eligible respondents (i.e., those that passed the eligibility screening)
    filter(inelig_stop ==  1) %>% 
    # Restrict to those who have data for relevant eligibility screening questions 
    filter(!if_all(c(elig_age, elig_sexuality, elig_gender,
                     elig_gender_msm, elig_sexual_partners,
                     elig_healthcare), is.na)) %>%
    mutate(#! Variable name key: 
               #!  *_cat: indicates a categorical these are flags (0/1)
               #!  *_f: these are flags (0/1)
               #!  *_na: these are also flags but specifically related to missingness (NA = missing in R)
               #!  *_int: these refer to some calculate interval
               #!  pd: an abbreviation for period
          
      eligibility_date = ymd("2022-08-19"),
      redcap_trans_date = ymd("2023-01-20"),
    #==== General cleaning ----
          
          # Format all yes/no variables with 1(Yes)/2(No) values as 1(Yes)/0(No).
           across(contains(c("elig_age", "elig_gender_msm", "elig_sexual_partners",
                             "elig_healthcare", "first_dose_yesno", "second_dose_yesno",
                             "symptoms_yesno", "provider_dx", "clinic_yesno", "hospitalized",
                             "dose1_yesno", "dose2_yesno"), ignore.case = TRUE), give_two_a_zero),
           
           # Format all date variables as YYYY-MM-DD
           across(contains("_date", ignore.case = TRUE), ymd),
           # Check the presence of a jurisdiction ID
           juris_detect = case_when(str_detect(pid, "CA_|CO_| CT_|DC_|GA_|LAC_|MD_|MN_|NYC_|NYS_|OR_|TN_") ~ 1,
                           TRUE ~ as.numeric(0)),

           # Rename REDCap Data Access Group variable and capitalize the letters
           jid = fct_relevel(as_factor(toupper(redcap_data_access_group)),
                             "CA", "LAC", "CO", "CT", "GA", "MD", "MN",
                             "NYS", "NYC", "OR", "TN", "DC"),

    #==== Minimum data elements ----
          
           # Create indicator vars to help flag records missing minimum set of data elements need for VE  variables
          
           provider_dx_na = case_when(is.na(provider_dx) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           clinic_yesno_na = case_when((provider_dx == 0 | is.na(provider_dx)) & is.na(clinic_yesno) ~ 1,
                                       TRUE ~ as.numeric(0)),
           
           clinic_date_na = case_when(clinic_yesno == 1 & is.na(clinic_date) ~ 1,
                                      TRUE ~ as.numeric(0)),
          
           symptoms_yesno_na = case_when(is.na(symptoms_yesno) ~ 1,
                                         TRUE ~ as.numeric(0)),
           
           symptoms_date_na = case_when(symptoms_yesno == 1 & is.na(symptoms_date) ~ 1,
                                        TRUE ~ as.numeric(0)),
           
           first_dose_yesno_na = case_when(is.na(first_dose_yesno) ~ 1,
                                           TRUE ~ as.numeric(0)),
           
           first_dose_date_na = case_when(first_dose_yesno == 1 & is.na(first_dose_date) ~ 1,
                                          TRUE ~ as.numeric(0)),
           
           second_dose_yesno_na = case_when(first_dose_yesno == 1 & is.na(second_dose_yesno) ~ 1,
                                            TRUE ~ as.numeric(0)),
           
           second_dose_date_na = case_when(second_dose_yesno == 1 & is.na(second_dose_date) ~ 1,
                                           TRUE ~ as.numeric(0)),
          
           # Flag records missing any minimum set of data element needed for VE estimate
           minset_vars_self = fct_relevel(as_factor(ifelse(if_any(contains("_na"), ~ . == 1), "Incomplete", "Complete")),
                                          "Complete", "Incomplete"),
    
           # minset_vars_anna = case_when((first_dose_yesno ==1 & is.na(first_dose_date)) |
           #                                (first_dose_yesno == 1 & is.na(second_dose_yesno)) |
           #                                (second_dose_yesno == 1 & is.na(second_dose_date)) |
           #                                is.na(symptoms_yesno) |
           #                                (symptoms_yesno == 1 & is.na(symptoms_date)) |
           #                                is.na(provider_dx)|
           #                                (provider_dx == 0 & is.na(clinic_yesno)) ~ "incomplete",
           #                              TRUE ~ as.character("complete")
           #                                ),
          
           # Create indicator vars to help flag records missing jurisdiction completed vax info
          
           case_yesno_na = case_when(is.na(case_yesno) ~ 1,
                                     TRUE ~ as.numeric(0)),
          
           test_result_date_na = case_when(case_yesno %in% c(1:2) & is.na(test_result_date) ~ 1,
                                           TRUE ~ as.numeric(0)),
           
           control_visit_date_na = case_when(case_yesno == 3 & is.na(control_visit_date) ~ 1,
                                              TRUE ~ as.numeric(0)),
           
           dose1_yesno_na = case_when(is.na(dose1_yesno) ~ 1,
                                      TRUE ~ as.numeric(0)),
           
           dose1_date_na = case_when(dose1_yesno == 1 & is.na(dose1_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           dose2_yesno_na = case_when(dose1_yesno == 1 & is.na(dose2_yesno) ~ 1,
                                      TRUE ~ as.numeric(0)),
           
           dose2_date_na = case_when(dose2_yesno == 1 & is.na(dose2_date) ~ 1,
                                     TRUE ~ as.numeric(0)),
           
           
           # Flag records missing any minimum set of data element needed for VE estimate
           minset_vars_site = fct_relevel(as_factor(ifelse(if_any(c("case_yesno_na", "test_result_date_na", "control_visit_date_na", 
                                              "dose1_yesno_na", "dose1_date_na",
                                              "dose2_yesno_na", "dose2_date_na",
                                              "symptoms_yesno_na", "symptoms_date_na"), ~ . == 1), "Incomplete", "Complete")),
                                          "Complete", "Incomplete"),
           
    #==== Case Ascertainment & index date ----
          #  2022-01-18 data call decisions:  
          #      Cases: Use site test result date, and if missing, use self-reported symptoms date
          #      Controls: Use self-report clinic date, if self-reported missing OR before Aug 19th, then use the sit- reported clinic date

          # Create a study period variable to store mpox symptoms date within 2022-08-19 and most recent data transfer from jurisdictions. 
           
           study_pd_int = interval(eligibility_date, redcap_trans_date),
    
          # Case status categories
           caco_stat_cat = fct_relevel(as_factor(case_when(case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    symptoms_yesno == 1 & # Experienced symptoms
                                                    ((test_result_date %within% study_pd_int)  | # Site-reported test result date complete Or 
                                                       ((is.na(test_result_date) |# if incomplete or 
                                                          test_result_date < eligibility_date) & # before Aug 19 
                                                           (symptoms_date %within% study_pd_int)))      ~ "Case",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    is.na(provider_dx) &
                                                    symptoms_yesno == 1 & # Experienced symptoms
                                                    ((test_result_date %within% study_pd_int)  | # Site-reported test result date complete Or 
                                                       ((is.na(test_result_date) |# if incomplete or 
                                                          test_result_date < eligibility_date) & # before Aug 19 
                                                           (symptoms_date %within% study_pd_int)))      ~ "Case: provider_dx NA",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    symptoms_yesno != 1  ~ "Case: symptom -",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    symptoms_yesno == 1 &
                                                    (((test_result_date < eligibility_date | is.na(test_result_date)) &
                                                       symptoms_date < eligibility_date) |
                                                    (is.na(test_result_date) & is.na(symptoms_date))) ~ "Case: date issue",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    (provider_dx !=1 |
                                                    symptoms_yesno != 0 &
                                                    clinic_yesno == 1 & !is.na(clinic_date)) ~ "Case-site, Control-self",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    provider_dx == 1 ~ "Control-site, Case-self",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    provider_dx != 1 &
                                                    symptoms_yesno !=1 & # no reported symptoms
                                                    ((clinic_date %within% study_pd_int) | # self-reported clinic date complete
                                                    ((is.na(clinic_date_na) |
                                                        clinic_date < eligibility_date) & # Self-reported clinic data missing OR before August 19th but site reported clinic date available
                                                       control_visit_date %within% study_pd_int))      ~ "Control",
                                                
                                                  
                                                  case_yesno == 3 & # Site-reported as confirmed or probable case
                                                    (((clinic_date < eligibility_date ) &
                                                       (control_visit_date < eligibility_date)) |
                                                    ((clinic_date < eligibility_date ) &
                                                       control_visit_date_na == 1) |
                                                    (is.na(clinic_date) & 
                                                       (control_visit_date < eligibility_date)) |
                                                    (is.na(clinic_date) & is.na(control_visit_date))) ~ "Control: date issue",
                                                  
                                                  
                                                   case_yesno == 3 & # Site-reported as control
                                                    symptoms_yesno == 1 & # no reported symptoms
                                                    ((clinic_date_na == 0 & clinic_date %within% study_pd_int) | # self-reported clinic date complete
                                                    ((clinic_date_na == 1 |
                                                        clinic_date < eligibility_date) & # Self-reported clinic data missing OR before August 19th but site reported clinic date available
                                                       control_visit_date %within% study_pd_int))      ~ "Control: symptom +",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    symptoms_yesno == 0 & # no reported symptoms
                                                    clinic_yesno != 1 & # no clinic visit
                                                    !is.na(control_visit_date) & # site reported data complete and >= Aug 19
                                                    control_visit_date >= eligibility_date  ~ "Control: no clinic visit-self",
                                                  
                                                  case_yesno_na == 1 ~ "Site-report missing",
                                                  
                                                  TRUE ~ as.character(NA))),
                              "Case", 
                              "Case: date issue",  
                              "Case: provider_dx NA", "Case: symptom -",
                              "Control",  
                              "Control: symptom +",
                              "Control: no clinic visit-self",
                              "Control: date issue",
                              "Case-site, Control-self",
                              "Control-site, Case-self", 
                              "Site-report missing"),
    # binary case status
    caco = fct_relevel(as_factor(case_when(caco_stat_cat %in% c("Case", "Case: provider_dx NA") ~ "Case",
                                           caco_stat_cat %in% c("Control", "Control: no clinic visit-self",
                                                                "Control: symptom +") ~ "Control",
                                           TRUE ~ as.character(NA))),
                       "Case", "Control"),
    
    #==== Index date (mpox symptom onset [for cases] or clinic visit date [for controls]) ---------
           
           index_date = case_when(caco == "Case" &
                                    (test_result_date %within% study_pd_int) ~ test_result_date,
                                  caco == "Case" &
                                    ((is.na(test_result_date) | #if incomplete or 
                                        (test_result_date < eligibility_date)) & # before Aug 19 
                                       (symptoms_date %within% study_pd_int)) ~ symptoms_date,
                                  caco == "Control" &
                                    (clinic_date %within% study_pd_int) ~ clinic_date,
                                  caco == "Control" &
                                    ((is.na(clinic_date) | #if incomplete or 
                                        (clinic_date < eligibility_date)) & # before Aug 19 
                                       (control_visit_date %within% study_pd_int)) ~ control_visit_date,
                                  TRUE ~ as.Date(NA)),
            index_date_na = fct_relevel(as_factor(case_when(!is.na(index_date) ~ "Complete",
                                                            TRUE ~ as.character("Incomplete"))),
                                        "Complete", "Incomplete"),
            index_year =  year(index_date),
    
            
    
    #==== Vaccination Status ----
      
            # Time (days) between index event date and 1st/2nd doses
              # Site
            dose1index_days_site = index_date - dose1_date,

            dose2index_days_site = index_date - dose2_date,
      
            dose_int_site = dose2_date - dose1_date,
            
              # Self
            dose1index_days_self = index_date - first_dose_date,

            dose2index_days_self = index_date - second_dose_date,
      
            dose_int_self = second_dose_date - first_dose_date,

            
            # Vax status: Site
            vax_stat_site_na = as.character(NA),
            vax_stat_site = fct_relevel(as_factor(case_when(!is.na(index_date) & 
                                                              ((dose1_yesno == 0 &                       # no documented vaccination
                                                                   is.na(dose2_yesno)) |                 
                                                                   (dose1_yesno == 1 &                   # 1 dose but dose1-index date interval < 14 days
                                                                     dose1index_days_site <= 0))    ~ "Unvaccinated",
                                                                 (dose1_yesno == 1 & dose2_yesno != 1 &   # 1 dose partial (1st dose but no 2nd dose)
                                                                   dose1index_days_site >= 14) |
                                                                   (dose1_yesno == 1 & dose2_yesno == 1 & # 1 dose partial
                                                                      dose1index_days_site >= 14 &          # (2 doses but dose interval <24 days)
                                                                      dose_int_site <24)  |
                                                                   (dose2_yesno == 1 &                    # 2 doses partial
                                                                      dose1index_days_site >= 14 &          # (dose 2-index date interval < 14 days )
                                                                      dose_int_site >=24 & dose2index_days_site < 14) ~ "Partially vaccinated",
                                                                 (dose2_yesno == 1 &
                                                                   dose_int_site >=24 & dose2index_days_site >= 14) ~ "Fully vaccinated",
                                                            TRUE ~ as.character(vax_stat_site_na))),
                                   "Fully vaccinated", "Partially vaccinated", "Unvaccinated"),
      
      vax_stat_self_na = as.character(NA),
      vax_stat_self = fct_relevel(as_factor(case_when(!is.na(index_date) & 
                                                        ((first_dose_yesno == 0 &
                                                             is.na(second_dose_yesno)) |
                                                             (first_dose_yesno == 1 &
                                                               dose1index_days_self %in% (1:13)) |
                                                             first_dose_yesno == 1 & dose1index_days_self <= 0)    ~ "Unvaccinated",
                                                           (first_dose_yesno == 1 & second_dose_yesno != 1 &
                                                             dose1index_days_self >= 14) |
                                                             (first_dose_yesno == 1 & second_dose_yesno == 1 &
                                                                dose1index_days_self >= 14 & 
                                                                dose_int_self <24)  |
                                                             (second_dose_yesno == 1 &
                                                                dose1index_days_self >= 14 & 
                                                                dose_int_self >=24 & dose2index_days_self < 14) ~ "Partially vaccinated",
                                                           (second_dose_yesno == 1 &
                                                             dose_int_self >=24 & dose2index_days_self >= 14) ~ "Fully vaccinated",
                                                      TRUE ~ as.character(vax_stat_self_na))),
                             "Fully vaccinated", "Partially vaccinated", "Unvaccinated"), 
    
    #==== DQ Check: Non-vaccination ----
  
        # symptom Onset Date vs Test Date (Cases) - Compare symptom onset date to ensure same day as
        #                                           or before positive test result (cases only)
    
         symp_gt_test_date_f = fct_relevel(as_factor(case_when(caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date >= test_result_date) ~ "Yes",
                                                               caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date < test_result_date) ~ "No",
                                                               caco == "Control"                     ~ "Not applicable, control",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No", "Not applicable, control"),
        
        # Clinic Visit Date – HD vs Self Report (Controls) - Compare  clinic visit as reported from HD compared to self-report 
        #                                                    Flag if (clinic_date - control_visit_date) > +/- 2
         clinic_v_control_date = fct_relevel(as_factor(case_when(!is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) > 20) ~ "Abs > 20 days: Yes",
                                                                 !is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) <= 20) ~ "Abs > 20 days: No",
                                                                 TRUE ~ as.character(NA))),
                                             "Abs > 20 days: Yes", "Abs > 20 days: No"),
    #==== DQ Check: Vaccination variables ----
           
           # Dose 1 and Dose 2 Vaccination Interval (self-report) - Flag interval < 24 days and > 24 days to ID implausible intervals
          dose_int_self = ifelse(!is.na(first_dose_date) & !is.na(second_dose_date), second_dose_date - first_dose_date, NA), 
          dose_int_cat_self = fct_relevel(as_factor(case_when(first_dose_yesno != 1                                   ~ "Not Vaxed",
                                                                !is.na(first_dose_date) & is.na(second_dose_date)    ~ "Dose #1 only",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) < 24)        ~ "<24 days",
                                                             !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  (((second_dose_date - first_dose_date) %in% c(24:28)))  ~ "24-28 days",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) > 28)            ~ ">28 days",
                                                             TRUE ~ as.character(NA))),
                                       "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"),
           
         
    
          # site-report: Dose 1 and Dose 2 Vaccination Interval - Flag interval < 24 days and > 24 days to ID implausible intervals
         dose_int_site = ifelse(!is.na(dose1_date) & !is.na(dose2_date), dose2_date - dose1_date, NA),
         dose_int_cat_site = fct_relevel(as_factor(case_when(dose1_yesno != 1                             ~ "Not Vaxed",
                                                              !is.na(dose1_date) & is.na(dose2_date)      ~ "Dose #1 only",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) < 24)          ~ "<24 days",
                                                           !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                  (((dose2_date - dose1_date) %in% c(24:28)))  ~ "24-28 days",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) > 28)          ~ ">28 days",
                                                           TRUE ~ as.character(NA))),
                                         "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"
                                                           ),
        # Vaccine Dose Number – HD vs Self Report: Compare number of vaccine doses reported from HD compared to self-report
          site_v_self_dose1 = fct_relevel(as_factor(case_when((dose1_yesno == 1 & first_dose_yesno == 1) |
                                                                (dose1_yesno == 0 & first_dose_yesno == 0) ~ "Same",
                                                              (dose1_yesno == 1 & first_dose_yesno == 0)   ~ "Site-Vax",
                                                              (dose1_yesno == 0 & first_dose_yesno == 1)   ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
          site_v_self_dose2 = fct_relevel(as_factor(case_when((dose2_yesno == 1 & second_dose_yesno == 1) |
                                                                (dose2_yesno == 0 & second_dose_yesno == 0) ~ "Same",
                                                              (dose2_yesno == 1 &
                                                                 (second_dose_yesno == 0 | is.na(second_dose_yesno)))   ~ "Site-Vax",
                                                              ((dose2_yesno == 0 | is.na(dose2_yesno)) &
                                                                 second_dose_yesno == 1)  ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
    
       # Vaccine Administration Date – HD vs Self Report: Compare dates of vaccination administration between
       #                                                  HD and self-report (add +/- 1 or 2 days)
    
        site_v_self_vaxdate1 = fct_relevel(as_factor(case_when(!is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) > 2) ~ "Abs > 2: Yes",
                                                               !is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) <= 2) ~ "Abs > 2: No",
                                                               TRUE ~ as.character(NA))),
                                         "Abs > 2: Yes", "Abs > 2: No"),
       
       site_v_self_vaxdate2 = fct_relevel(as_factor(case_when(!is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) > 2) ~ "Abs > 2: Yes",
                                                              !is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) <= 2) ~ "Abs > 2: No",
                                                              TRUE ~ as.character(NA))),
                                          "Abs > 2: Yes", "Abs > 2: No"),
    

      #==== DQ Check: Other vars ----
       # Check to make sure birth year is within range of a person being between 18-49 years old
       #               Invalid birth years/ages should be captured via REDCap checks, except for some unusual
       #                situations which should be reviewed and resolved on a case-by-case basis 
              # Calculate age based on birth year and symptom or clinic date
              age_cal = year(index_date) - birth_year,
              # Flag if submitted date– birth_year <18 | > 49 (AOD: we do not have submitted date) 
              age_f = fct_relevel(as_factor(case_when(age_cal < 18          ~ "<18",
                                                            age_cal %in% c(18:49) ~ "18-49",
                                                            age_cal > 49          ~ "\u226550",
                                                            TRUE ~ as.character(NA))),
                                        "<18", "18-49", "\u226550"),
    
    
    
         # Length of Hospitalization - Examine if length of days of hospitalization is longer than
          #                             the time between illness onset and survey submission
          #                             Flag if hospitalized_days > (submitted date - symptoms_date)
          #!                            AOD: We do not have a submitted date variable at CDC as the sites
          #!                                are not uploading the time stamps. However, only 2 people reported
          #!                                being hospitalized and their days of hospitalization (3 & 13) seem plausible.
         hospitalized_cat = fct_relevel(as_factor(case_when(hospitalized == 0 ~ "No",
                                                            hospitalized == 1 ~ "Yes",
                                                            TRUE ~ as.character(NA))),
                                        "Yes", "No"),
          hospitalized_days_cat = fct_relevel(as_factor(case_when(hospitalized_days == 0         ~ "0",
                                                                  hospitalized_days %in% c(1:7)   ~ "1-7",
                                                                  hospitalized_days %in% c(8:14)  ~ "8-14",
                                                                  hospitalized_days %in% c(15:21) ~ "15-21",
                                                                  hospitalized_days %in% c(22:28) ~ "22-28",
                                                                  hospitalized_days >= 29         ~ "\u226529",
                                                                  TRUE ~ as.character(NA))),
                                              "0", "1-7","8-14", "15-21", "22-28", "22-28", "\u226529"),
    
          # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #                             AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls           #                                  categorization included below.
          
          # Prior Smallpox Vaccination Timing flag
           smallpox_birth_f = fct_relevel(as_factor(case_when((priorvax == 1 & (birth_year < priorvax_year)|
                                                                priorvax %in% c(2:3)) ~ "Plausible",
                                                              priorvax == 1 & (birth_year > priorvax_year) ~ "Implausible",
                                                              priorvax == 1 & is.na(birth_year) ~ "birth year missing",
                                                              priorvax == 1 & is.na(priorvax_year) ~ "Vax year missing",
                                                            TRUE ~ as.character(NA))),
                                        "Plausible", "Implausible", "birth year missing", "Vax year missing"),
    # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #                             AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls           #                             
          sex_part_num = ifelse(caco == "Case", sex_part_num_case, 
                               ifelse(caco == "Control", sex_part_num_control, NA)),
          sex_part_num_cat = fct_relevel(as_factor(case_when(sex_part_num == 0 ~ "0",
                                                            sex_part_num %in% c(1:3) ~ "1-3",
                                                            sex_part_num %in% c(4:6) ~ "4-6",
                                                            sex_part_num %in% c(7:9) ~ "7-9",
                                                            sex_part_num %in% c(10:12) ~ "10-12",
                                                            sex_part_num >= 13 ~ "13+",
                                                            TRUE ~ as.character(NA))),
                                         "0", "1-3", "4-6", "7-9", "10-12", "13+"),
      
    #==== Analysis variables and other data cleaning----         
      # Age categorical
              age_cat = fct_relevel(as_factor(case_when(age_cal %in% c(18:29) ~ "18-29",
                                                        age_cal %in% c(30:39) ~ "30-39",
                                                        age_cal %in% c(39:49) ~ "40-49",
                                                         age_cal == 50          ~ "50",
                                                        age_cal >= 51          ~ "\u226551", # There are a couple people with age >49
                                                            TRUE ~ as.character(NA))),
                                        "18-29", "30-39", "40-49",  "50", "\u226551"),
    
    # Flag those who reported having experienced mpox symptoms and specified one of the listed symptoms 
             symptom_type_complete = ifelse(symptoms_yesno == 1 &
                                                 if_any(contains("symptom_type___"), ~ . == 1),
                                               1,
                                               ifelse(symptoms_yesno == 1 &
                                                         if_all(contains("symptom_type___"), ~ . == 0),
                                                       0, NA))
      
      
      
       
            ) %>% 
  select(pid, jid, everything(), -redcap_data_access_group)

  
```

## **Part 1: Key data elements and case status**

In part 1, we examine missingness patterns of the key data elements, especially those that are related to case and control classification.

### Minimum set of data elements needed for VE estimation: Components

Although we have a minimum set of data elements, this is composed of self-reported data. We decided to define a site-specific minimum set of data elements in Table 1 because we will primarily rely on the site-reported case status classification for our analysis.

**Table 1. Minimum set of data elements**

| **Minimum set^a^**                              | **Variable names^b^**                                       | **Labels**                                                                                                                                                            |
|-------------------|-------------------|----------------------------------|
| [*Site and self-reported symptoms*]{.underline} | [*Case and Vaccination Status & Questionnaire*]{.underline} |                                                                                                                                                                       |
| X                                               | case_yesno                                                  | Is this individual a confirmed or probable MPX case-patient with symptom onset on or after August 19, 2022?                                                           |
|                                                 | test_result_date                                            | What is the case patient's date of the positive test result?                                                                                                          |
|                                                 | control_visit_date                                          | Date of clinic visit (used for enrollment to frequency match controls to cases by 2-4 week period):                                                                   |
| X                                               | symptoms_yesno                                              | Have you ever had symptoms consistent with monkeypox, such as a rash or skin lesions?                                                                                 |
|                                                 | symptoms_date                                               | What was the date that you first started experiencing symptoms or got a rash or skin lesions? (If you can't remember the exact date, please provide your best guess.) |
| X                                               | dose1_yesno                                                 | Dose #1 received                                                                                                                                                      |
|                                                 | dose1_date                                                  | Dose #1 date                                                                                                                                                          |
|                                                 | dose2_yesno                                                 | Dose #2 received                                                                                                                                                      |
|                                                 | dose2_date                                                  | Dose #2 date                                                                                                                                                          |
| [*Self-report only*]{.underline}                | [*Questionnaire*]{.underline}                               |                                                                                                                                                                       |
| X                                               | first_dose_yesno                                            | Have you received a first dose of JYNNEOS monkeypox vaccine?                                                                                                          |
|                                                 | first_dose_date                                             | When did you receive your first monkeypox vaccine? If you can't remember the exact date, please provide your best guess.                                              |
|                                                 | second_dose_yesno                                           | Have you received a second dose of JYNNEOS monkeypox vaccine?                                                                                                         |
|                                                 | second_dose_date                                            | When did you receive your second monkeypox vaccine? If you can't remember the exact date, please provide your best guess.                                             |
| X                                               | symptoms_yesno                                              | Have you ever had symptoms consistent with monkeypox, such as a rash or skin lesions?                                                                                 |
|                                                 | symptoms_date                                               | What was the date that you first started experiencing symptoms or got a rash or skin lesions? (If you can't remember the exact date, please provide your best guess.) |
| X                                               | provider_dx                                                 | Have you ever been told by a doctor or healthcare provider that you have monkeypox?                                                                                   |
| X                                               | clinic_yesno                                                | Have you visited an STI or HIV clinic, infectious disease clinic, or PrEP clinic between August 19, 2022, and today?                                                  |
|                                                 | Clinic_date                                                 | Clinic visit date                                                                                                                                                     |

### Minimum set of data elements---site versus self + index date available


**Table 2. Distribution of respondents with a minimum set of data elements by site- and self-report and an index date**

```{r}
mpoxve %>% 
  filter(!is.na(caco_stat_cat)) %>% 
  select(jid, minset_vars_site, minset_vars_self,
         index_date_na) %>% 
  tbl_summary(
    by = jid,
    label = list(minset_vars_site ~ "Site",
                 minset_vars_self ~ "Self",
                 index_date_na ~ "Index date")
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()

```

### Distribution of case status

**Table 3. Case status**

```{r}
mpoxve %>% 
  select(jid, caco_stat_cat) %>% 
  tbl_summary(
    by = jid,
    label = list(caco_stat_cat ~ "Case status"),
    missing = "always",
    missing_text = "Missing"
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()
```

### List of enrolled respondents case status issues

**Table 4. Case: no symptoms and dates missing **

We exclude those who did not report symptoms or had a test result and symptom onset date before 19 August.

```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Case: date issue",
                               "Case: symptom -")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx, symptoms_yesno, test_result_date, symptoms_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         symptoms_yesno = fct_relevel(as_factor(case_when(symptoms_yesno == 0 ~ "No",
                                                          symptoms_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  arrange(caco_stat_cat) %>% 
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```


**Table 5. Control: no clinic visit-self  **

We include those who did not self-report clinic visit but have a site-reported clinic visit date in the main analysis. We will drop them from any analyses with examining the mpox exposure history because we will not have any of the mpox exposure history, and other sensitivity analyses.


```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Control: no clinic visit-self")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx, clinic_yesno, clinic_date, control_visit_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "No",
                                                          clinic_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```


**Table 6. Control: date issue  **

As now now, we will exclude these respondents for missing respondents do not have a self- and a site reported date, and those missing a self-reported clinic visit date but has site-reported date 19 August. There are other respondents with implausible dates likely due to entry errors. 


```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Control: date issue")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx, clinic_yesno, clinic_date, control_visit_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "No",
                                                          clinic_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```



**Table 7. Discrepancy: Case-site, Control-self  **

Will reach out to LAC to confirm that this is a case. 


```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Case-site, Control-self")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx,  symptoms_yesno, test_result_date, symptoms_date, clinic_yesno, clinic_date, control_visit_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "No",
                                                          clinic_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No"),
         symptoms_yesno = fct_relevel(as_factor(case_when(symptoms_yesno == 0 ~ "No",
                                                          symptoms_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```

**Table 8. Discrepancy: Control-site, Case-self  **

Most of these are from Maryland, Oumar will reach out to sites to confirm this information.

```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Control-site, Case-self")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx,  symptoms_yesno, test_result_date, symptoms_date, clinic_yesno, clinic_date, control_visit_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "No",
                                                          clinic_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No"),
         symptoms_yesno = fct_relevel(as_factor(case_when(symptoms_yesno == 0 ~ "No",
                                                          symptoms_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```

**Table 9. Discrepancy: Site-report missing **

The Tennessee folks are responds will probably be excluded for missing self-reported data too.

```{r}
mpoxve %>%
   filter(caco_stat_cat %in% c("Site-report missing")) %>% 
  select(pid, caco_stat_cat, case_yesno, provider_dx,  symptoms_yesno, test_result_date, symptoms_date, clinic_yesno, clinic_date, control_visit_date) %>%
  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "Confirmed",
                                                      case_yesno == 2 ~ "Probable",
                                                      case_yesno == 3 ~ "Control",
                                                      TRUE ~ as.character(NA))),
                                  "Confirmed", "Probable", "Control"),
         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "No",
                                                       provider_dx == 1 ~ "Yes",
                                                       TRUE ~ as.character(NA))),
                                  "Yes", "No"),
         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "No",
                                                          clinic_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No"),
         symptoms_yesno = fct_relevel(as_factor(case_when(symptoms_yesno == 0 ~ "No",
                                                          symptoms_yesno == 1 ~ "Yes",
                                                     TRUE ~ as.character(NA))),
                                      "Yes", "No")) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```

**Table 10. Index date missing **

```{r}
mpoxve %>%
   filter(index_date_na == "Incomplete") %>% 
  select(pid, caco_stat_cat, index_date, test_result_date, symptoms_date,  clinic_date, control_visit_date) %>%
  arrange(caco_stat_cat) %>% 
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
```


## **Part 2: Vaccination Status**


**Definitions:**

-   [Fully vaccinated:]{.underline} Receipt of two doses of JYNNEOS vaccine at least 24 days apart, with the second dose having been administered \>13 days before index date (mpox symptom onset [for cases] or clinic visit date [for controls]).

-   [Partially vaccinated:]{.underline} Receipt of one dose of JYNNEOS vaccine \>13 days before index date or respondents with receipt of two doses of JYNNEOS vaccine \<14 days before index date.

-   [Unvaccinated:]{.underline} Without receipt of any doses of JYNNEOS vaccine or receipt of the vaccine after index date

    -   [Vaccinated post-index date:]{.underline} We wanted to pull these people out (see Table 14) to ask what would be the impact of this high proportion on the VE results? Does it impact statistical power if we account for index date in the vaccination coverage calculation?

-   [PEP vaccination]{.underline}: Receipt of one dose of JYNNEOS vaccine within 13 days after exposure to a person diagnosed with mpox (confirmed or probable case) and before index date.

    -   [In the analysis plan, this definition is presented in the tables as a mutually exclusive category, but it is not. Because of this and we have not delved into the mpox exposure history variables, we have not coded it yet]{.underline}

**Table 11. Distribution of vaccination status among those with a complete index date**

```{r}
mpoxve %>%
  filter(index_date_na == "Complete") %>% 
  select(caco, vax_stat_site, vax_stat_self) %>% 
  tbl_summary(
    by = caco,
    label = list(vax_stat_site ~ "Site",
                 vax_stat_self ~ "Self"
                 
                 ),
     #percent = "column",
    missing = "always",
    missing_text = "Missing"
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()

```


**Table 12. List of respondents missing site vaccination status **


```{r}
mpoxve %>%
  filter(index_date_na == "Complete" & is.na(vax_stat_site)) %>% 
  select(pid, caco_stat_cat, dose1_yesno, dose1_date, dose2_date, dose2_date, index_date, dose1index_days_site, dose_int_site) %>%
  DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))

```



## **Part 3: Vaccination related variables**

### **Table 13. Dose 1 and Dose 2 vaccination interval: site & self**

```{r}
mpoxve %>%
  filter(index_date_na == "Complete") %>% 
  select(caco, dose_int_cat_site, dose_int_cat_self) %>%
  tbl_summary(
    by = caco,
    label = list(dose_int_cat_site ~ "Site",
                 dose_int_cat_self ~ "Self"),
    missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels()

```

### **Table 14. Vaccine dose number: site versus self**

```{r}
mpoxve %>%
  filter(index_date_na == "Complete") %>% 
  select(caco, site_v_self_dose1, site_v_self_dose2) %>%
  tbl_summary(
    by = caco,
    label = list(site_v_self_dose1 ~ "Dose #1",
                 site_v_self_dose2 ~ "Dose #2"),
    missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels()

```

### **Table 15. Vaccine administration date: site versus self (+/- 2 days)**

```{r}
mpoxve %>%
  filter(index_date_na == "Complete") %>% 
  select(caco, site_v_self_vaxdate1, site_v_self_vaxdate2) %>%
  tbl_summary(
    by = caco,
    label = list(site_v_self_vaxdate1 ~ "Dose #1",
                 site_v_self_vaxdate2 ~ "Dose #2"),
    missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels()

```

<!-- ## **Part 4: Plausibility of key dates (non-vaccination)** -->

<!-- In Part 4, we explore explore the plausibility of key dates. We restrict the analysis to respondents with per protocol case status definition before apply additional restrictions where necessary. -->


<!-- ### **Symptom Onset Date vs Test Date (Cases)** -->

<!-- How should we handle these 11 records where the symptom onset date is after the positive test result? -->

<!-- **Table 15. list of cases with symptom onset date after positive test result** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--   filter(caco == "Case" & index_date_na == "Complete" & symp_gt_test_date_f == "Yes") %>%  -->
<!--   select(pid, symptoms_date, test_result_date) %>% -->
<!--   DT::datatable(., extensions='Buttons', -->
<!--                      options = list( -->
<!--                        searching = T, -->
<!--                        pageLength = 10, -->
<!--                        dom = 'Bfrtip', -->
<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Clinic visit date---site vs Self report (controls)** -->

<!-- Flag if records with the absolute difference in days between the site and self-reported clinic date is \>2. Among the 60 records with the absolute difference in days between the site and self-reported clinic date is \>2, there are 20 records with an absolute difference in days \>28 days. What should we do with this? -->

<!-- **Table 16. list of controls with absolute difference in days between the site and self-reported clinic date is \>2** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--   filter(caco == "Control" & clinic_v_control_date == "Abs > 20: Yes") %>% # restrict to per protocol definition of case status = cases -->
<!--   select(pid, control_visit_date, clinic_date) %>% -->
<!--    DT::datatable(., extensions='Buttons', -->
<!--                      options = list( -->
<!--                        searching = T, -->
<!--                        pageLength = 10, -->
<!--                        dom = 'Bfrtip', -->
<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Smallpox vaccination year** -->

<!-- **Table 17. Smallpox vaccination timing** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--    filter(index_date_na == "Complete") %>%  -->
<!--   select(caco, smallpox_birth_f) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(smallpox_birth_f ~ "Smallpox"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->


<!-- ## **Part 5: Age, hospitalization, and number of sexual partners** -->

<!-- ### **Age** -->

<!-- **Table 18. Distribution of age** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->
<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->
<!--   filter(is.na(caco) == F) %>% -->
<!--   select(caco, age_f, age_cat) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(age_f ~ "Age", -->
<!--                  age_cat ~ "Age Distribution"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->

<!-- **Table 16. List of respondents missing birth year** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->

<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->

<!--   filter(is.na(caco) == F) %>% -->

<!--   filter(is.na(age_cal))%>% -->

<!--   select(caco, pid, index_year, birth_year, symptoms_date, test_result_date, control_visit_date, clinic_date)  %>% -->

<!--   rename(PID = pid, `Birth year` = birth_year) %>% -->

<!--   DT::datatable(., extensions='Buttons', -->

<!--                      options = list( -->

<!--                        searching = T, -->

<!--                        pageLength = 10, -->

<!--                        dom = 'Bfrtip', -->

<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Length of hospitalization** -->

<!-- For the length of Hospitalization, we want to examine if length of days of hospitalization is longer than the time between illness onset and survey submission (flag if hospitalized_days \> (submitted date - symptoms_date). However, we do not have a 'submitted date' variable at CDC as the sites are not uploading the time stamps. However, only 4 people reported being hospitalized and their days of hospitalization seem plausible. *Note*: Length of hospitalization was assessed among those who self-reported as having been told by a provider they have mpox. -->

<!-- **Table 16. Distribution of hospitalization** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->
<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->
<!--   filter(caco == "Case") %>% -->
<!--   select(hospitalized_cat, hospitalized_days_cat) %>% -->
<!--   tbl_summary( -->
<!--     label = list(hospitalized_cat ~ "Hospital", -->
<!--                  hospitalized_days_cat ~ "Days hospitalized" ), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->
<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   bold_labels() -->

<!-- ``` -->

<!-- ### **Number of sexual partners** -->

<!-- For the number of sexual partners, we want to examine the distribution of number of sexual partners for any implausible values. What values should we consider as implausible? -->

<!-- **Table 17. Distribution of sexual partners** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->
<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->
<!--   filter(is.na(caco) == F) %>% -->
<!--   select(caco, sex_part_num, sex_part_num_cat) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(sex_part_num ~ "# sexual partners", -->
<!--                  sex_part_num_cat ~ "# sexual partners" -->
<!--                  ), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->
