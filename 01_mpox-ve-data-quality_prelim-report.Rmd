---
title: "Data Quality Report" 
subtitle: "2022 Mpox Multi-Jurisdictional Case-Control VE Public Health Evaluation"
author: "Report by Case-Control Unit | VE Team | VTF | 2022 Multinational Monkeypox Response"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
  # html_document:
    code_folding: hide
    highlight: tango
    #toc: yes
    toc_depth: 3
    #toc_float: yes
    editor_options:
      chunk_output_type: console
      canonical: true
      
    # word_document:
    # reference_docx: "template.docx"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## **Report objective**

Examine data quality, clean data, and create analysis variables.

```{r libraries, message = FALSE, warning = FALSE}

# Data in: Pulled data directly from REDCap using API token
# Initial program date: 2022-12-15
# Last modified date: 2023-01-20

# Load packages --------------------------------
  pacman::p_load(here,        # file paths relative to R project root folder
                 rio,         # import/export
                 readxl,      # read excel files
                 tidyverse,    # data management and visualization
                 purrr,        # iteration
                 janitor,      # data management: cleaning and exploring data
                 lubridate,    # working with dates/epiweeks
                 naniar,       # Working with data structures, summaries, and visualizations for Missing Data
                 arsenal,      # provides unctions for large-scale statistical summaries
                 ggsci,        # scientific journal and sci-fi themed color palettes for 'ggplot2'
                 cowplot,      # streamlined plot theme and plot annotations for 'ggplot2'
                 knitr,        # Provides a general-purpose tool for dynamic report generation in R
                 kableExtra,   # simplifies the way to manipulate the HTML or 'LaTeX' codes generated by 'kable()
                 DT,           # provides an R interface to the JavaScript library DataTables
                 gtsummary,    # publication-ready analytical and summary tables
                 tableone,     # Creates 'Table 1', i.e., description of baseline patient characteristics
                 stargazer,    # provides a way to create publication quality tables
                 plotly,        # creates interactive web-based graphs 
                 geepack,
                 broom,
                 sjPlot,   # to visualizing mixed-effects models
                 effects,   # to visualizing mixed-effects models
                 lme4,      # "golden standard" for mixed-effects modelling in R (no p-values,
                lmerTest,  # p-values for MEMs based on the Satterthwaite approximation
                report,    # mainly for an "report" function
                emmeans,   # post-hoc analysis
                knitr,     # beautifying tables
                sjstats,   # ICC - intraclass-correlation coefficient
                caret     # ML, model comparison & utility functions

                 
  )

# Global option number format
  options(scipen = 9999)

#GT Table Theme
  theme_gtsummary_journal(journal = "jama")
  theme_gtsummary_compact()
# Helper (custom functions) ------------------------------------------------------------
#This function replicates the SAS proc freq function with the '/ list missing statement'. 
#Source: https://github.com/asnr/sas-to-r
pfreq = function(...) {
  dplyr::group_by(...) %>%
    dplyr::summarize(n = n()) %>%
    dplyr::mutate(pct= round(100 * n/sum(n), 1)) 
  #mutate(Percent=paste0(round(100 * n/sum(n), 1), "%")) 
}

# This function helps create consistent values for Yes/No variables.
# by reassigning '2' values a zero. 
give_two_a_zero <- function(x){
  x[x == 2 ] <- 0
  x
}


# Source data and define environment variables ---------------------------------------------------------------------

  source("00_REDCap-API-linkage.R", local =knit_global())
  
  # raw <- here("data", "MultiJurisdictionalM_DATA_2023-01-21_2201.csv") %>% 
  # read_csv()

  # Environment variables for Rmarkdown purpose
    # This the date of the earliest symptom per the study protocol
    
      eligibility_date_v2 <- "19 Aug 2022"
  
    # This date represent the most recent data transfer from jurisdictions
    
      redcap_trans_date_v2 <- "03 Feb 2023"

# Tidy data ----------------------------------------------------------------------
mpoxve <- raw %>%
    # Restrict to eligible respondents (i.e., those that passed the eligibility screening)
    filter(inelig_stop ==  1) %>% 
    # Restrict to those who have data for relevant eligibility screening questions 
    filter(!if_all(c(elig_age, elig_sexuality, elig_gender,
                     elig_gender_msm, elig_sexual_partners,
                     elig_healthcare), is.na)) %>%
    mutate(#! Variable name key: 
               #!  *_cat: indicates a categorical these are flags (0/1)
               #!  *_f: these are flags (0/1)
               #!  *_na: these are also flags but specifically related to missingness (NA = missing in R)
               #!  *_int: these refer to some calculate interval
               #!  pd: an abbreviation for period
          
    
    #==== General variable cleaning ----
          
          # Format all yes/no variables with 1(Yes)/2(No) values as 1(Yes)/0(No).
           across(contains(c("elig_age", "elig_gender_msm", "elig_sexual_partners",
                             "elig_healthcare", "first_dose_yesno", "second_dose_yesno",
                             "symptoms_yesno", "provider_dx", "clinic_yesno", "hospitalized",
                             "dose1_yesno", "dose2_yesno"), ignore.case = TRUE), give_two_a_zero),
           
           # Format all date variables as YYYY-MM-DD
           across(contains("_date", ignore.case = TRUE), ymd),
           # Check the presence of a jurisdiction ID
           juris_detect = case_when(str_detect(pid, "CA_|CO_| CT_|DC_|GA_|LAC_|MD_|MN_|NYC_|NYS_|OR_|TN_") ~ 1,
                           TRUE ~ as.numeric(0)),

           # Rename REDCap Data Access Group variable and capitalize the letters
           jid = fct_relevel(as_factor(toupper(redcap_data_access_group)),
                             "CA", "LAC", "CO", "CT", "GA", "MD", "MN",
                             "NYS", "NYC", "OR", "TN", "DC"),

    #==== Index date (mpox symptom onset [for cases] or clinic visit date [for controls]) ----
    
         # Create a study period variable to store mpox symptoms date within 2022-08-19 and most recent data transfer 
          eligibility_date = ymd("2022-08-19"),
          redcap_trans_date = ymd("2023-02-03"),
    
          study_pd_int = interval(eligibility_date, redcap_trans_date),
    
          index_date = case_when(test_result_date %within% study_pd_int ~ test_result_date,
                                  ((is.na(test_result_date) | #if incomplete or
                                     (test_result_date < eligibility_date)) & # before Aug 19 
                                       (symptoms_date %within% study_pd_int)) ~ symptoms_date,
                                  clinic_date %within% study_pd_int ~ clinic_date,
                                  ((is.na(clinic_date) | #if incomplete or 
                                      (clinic_date < eligibility_date)) & # before Aug 19 
                                       (control_visit_date %within% study_pd_int)) ~ control_visit_date,
                                  TRUE ~ as.Date(NA)),
            

    #==== Case ascertainment----
          #  2022-01-18 data call decisions:  
          #      Cases: Use site test result date, and if missing, use self-reported symptoms date
          #      Controls: Use self-report clinic date, if self-reported missing OR before Aug 19th, 
          #                then use the sit- reported clinic date

          
          # Case status categories
           caco_stat_cat = fct_relevel(as_factor(case_when(
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    is.na(index_date)      ~ "Case: invalid date",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    (provider_dx == 0 &
                                                       clinic_yesno == 1) ~ "Case-site, Control-self",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    (provider_dx == 0 &
                                                       clinic_yesno != 1) ~ "Case: self-no dx & clinic visit",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    !is.na(index_date)     ~ "Case",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    provider_dx == 1     ~ "Control-site, Case-self",
                                                  
                                                 case_yesno == 3 & # Site-reported as confirmed or probable case
                                                    provider_dx != 1 &
                                                    is.na(index_date) ~ "Control: invalid date",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    clinic_yesno != 1 &
                                                    !is.na(index_date)  ~ "Control: no clinic visit-self",
                                                 
                                                  case_yesno == 3 & # Site-reported as control
                                                   clinic_yesno == 1 &
                                                    #provider_dx != 1 &
                                                    !is.na(index_date)    ~ "Control",
                                                
                                                  
                                                  is.na(case_yesno) ~ "Site-report missing",
                                                  
                                                  TRUE ~ as.character(NA))),
                              "Case", 
                              "Case: invalid date",
                              "Case: self-no dx & clinic visit",
                              "Control",
                              "Control: no clinic visit-self",
                              "Control: invalid date",
                              "Case-site, Control-self",
                              "Control-site, Case-self", 
                              "Site-report missing"),
    
    # binary case status: main analysis
    caco = fct_relevel(as_factor(case_when(caco_stat_cat %in% c("Case",
                                                                "Control-site, Case-self",
                                                                "Case-site, Control-self",
                                                                "Case: self-no dx & clinic visit") ~ "Case",
                                           caco_stat_cat %in% c("Control",
                                                                
                                                                "Control: no clinic visit-self") ~ "Control",
                                           TRUE ~ as.character(NA))),
                       "Case", "Control"),
    
    # binary case status: sensitivity analysis, controls who did not self-report as having clinic visit
    caco_sen = fct_relevel(as_factor(case_when(caco_stat_cat %in% c("Case") ~ "Case",
                                               caco_stat_cat %in% c("Control") ~ "Control",
                                               TRUE ~ as.character(NA))),
                           "Case", "Control"),
    
  # Re assign index dates 
  index_date = case_when((caco_stat_cat == "Control-site, Case-self" &
                                       (symptoms_date %within% study_pd_int)) ~ symptoms_date,
                                     (caco_stat_cat == "Case-site, Control-self" &
                                       (clinic_date %within% study_pd_int)) ~ clinic_date,
                                     !caco_stat_cat %in%c("Control-site, Case-self", "Case-site, Control-self") ~ index_date,
                                     TRUE ~ as.Date(NA)),
  
  index_yrmo = format_ISO8601(index_date, precision = "ym"),
  index_epiyr   = epiyear(index_date),
  index_epiwk   = epiweek(index_date),
  index_epiyrwk_2 = fct_relevel(as_factor(case_when(index_epiyr == 2022 &
                                                                 index_epiwk %in% c(33, 34)~ "2022: 33-34",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(35, 36)~ "2022: 35-36",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(37, 38)~ "2022: 37-38",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(39, 40)~ "2022: 39-40",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(41, 42)~ "2022: 41-42",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(43, 44)~ "2022: 43-44",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(45, 46)~ "2022: 45-46",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(47, 48)~ "2022: 47-48",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(49, 50)~ "2022: 49-50",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(51, 52)~ "2022: 51-52",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(1, 2)  ~  "2023: 1-2",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(3, 4)  ~  "2023: 3-4",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(5, 6)  ~  "2023: 5-6",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(7, 8)  ~  "2023: 7-8",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(9, 10)  ~ "2023: 9-10"))),
  
  index_epiyrwk_4 = fct_relevel(as_factor(case_when(index_epiyr == 2022 &
                                                                 index_epiwk %in% c(33, 34, 35, 36)~ "2022: 33-36",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(37, 38, 39, 40)~ "2022: 37-40",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(41, 42, 43, 44)~ "2022: 41-44",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(45, 46, 47, 48)~ "2022: 45-48",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(49, 50, 51, 52)~ "2022: 49-52",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(1, 2, 3, 4)  ~  "2023: 1-4",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(5, 6, 7, 8)  ~  "2023: 5-8",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(9, 10, 11, 12)  ~ "2023: 9-12"))),
  
  
  #==== Vaccination Status ----
          # Combine site- and self-reported vaccination dose variables
          vax1_yesno = case_when((is.na(dose1_yesno) & !is.na(first_dose_yesno)) |
                                   (dose1_yesno == 0 & first_dose_yesno == 1)      ~ first_dose_yesno,
                           TRUE ~ as.numeric(dose1_yesno)),
          
          vax1_date = case_when(is.na(dose1_date) &
                                  first_dose_yesno == 1 & !is.na(first_dose_date) ~ first_dose_date,
                           TRUE ~ as.Date(dose1_date)),
  
          vax1_yrmo = format_ISO8601(vax1_date, precision = "ym"),
          
          vax2_yesno = case_when((is.na(dose2_yesno) & !is.na(second_dose_yesno)) |
                                   (dose2_yesno == 0 & second_dose_yesno == 1) ~ second_dose_yesno,
                           TRUE ~ as.numeric(dose2_yesno)),
          
          vax2_date = case_when(is.na(dose2_date) &
                                  second_dose_yesno == 1 & !is.na(second_dose_date) ~ second_dose_date,
                           TRUE ~ as.Date(dose2_date)),
          
          vax2_yrmo = format_ISO8601(vax2_date, precision = "ym"),
  
          # Time (days) between index event date and 1st/2nd doses
          dose1index_days = index_date - vax1_date,

          dose2index_days = index_date - vax2_date,
    
          dose_int        = vax2_date - vax1_date,
          
          # Vax status: Site
          vax_stat_na = as.character(NA),
          vax_stat = fct_relevel(as_factor(case_when(!is.na(index_date) & 
                                                       ((vax1_yesno == 0 &  # no documented vaccination OR Post index event vax
                                                                 is.na(vax2_yesno))|
                                                          (vax1_date >= index_date)) ~ "Unvaccinated",
                                                     (vax1_yesno == 1 &                   # 1 dose but dose1-index date interval < 14 days
                                                           dose1index_days <= 13)    ~ "PEP",
                                                     ((vax1_yesno == 1 & vax2_yesno != 1 &   # 1 dose partial (1st dose but no 2nd dose)
                                                        dose1index_days >= 14) |
                                                       (vax1_yesno == 1 & vax2_yesno == 1 &  # D1 is <24 days before D2
                                                          dose1index_days >= 14 &      
                                                          dose_int <24) |
                                                       (vax2_yesno == 1 &                  # 2 doses partial
                                                          dose1index_days >= 14 &          # (dose 2-index date interval < 14 days )
                                                          dose_int >=24 & dose2index_days < 14)) ~ "Partially vaccinated",
                                                     (vax2_yesno == 1 &
                                                        dose_int >=24 & dose2index_days >= 14) ~ "Fully vaccinated",  
                                                     TRUE ~ as.character(vax_stat_na))),
                                 "Fully vaccinated", "Partially vaccinated", "PEP", "Unvaccinated"),
    
         # Exclude those who had 2 doses but D1 is <24 days before D2 for VE analysis
         vax_stat_ve = case_when((vax1_yesno == 1 & vax2_yesno == 1 & 
                                 dose1index_days >= 14 & dose_int <24) | # Scenario 5
                                  vax_stat == "PEP" ~ NA_character_,
                                 TRUE ~ as.character(vax_stat)),
  
         # Post-exposure prophylaxis
          pep_stat_ve = fct_relevel(as_factor(case_when(why_vax___1 == 1 ~ "PEP-Vaccinated",
                                                        vax_stat == "Unvaccinated" ~ "Unvaccinated",
                                                        TRUE ~as.character(NA))),
                                    "PEP-Vaccinated", "Unvaccinated"),
    
    #==== Minimum set variables ----
    # Create indicator vars to help flag records missing minimum set of data elements need for VE  variables
          minset_vars = fct_relevel(as_factor(case_when(is.na(case_yesno) |
                                                          is.na(vax1_yesno) |
                                                          (vax1_yesno == 1 & is.na(vax1_date)) |
                                                          (vax1_yesno == 1 & is.na(vax2_yesno)) |
                                                          (vax2_yesno == 1 & is.na(vax2_date)) |
                                                          #is.na(provider_dx) |
                                                                 #is.na(clinic_yesno) | 
                                                                 is.na(index_date) ~ "Incomplete",
                                                               TRUE ~ as.character("Complete"))),
                                          "Complete", "Incomplete"),
    
    #==== DQ Check: Non-vaccination ----
  
        # symptom Onset Date vs Test Date (Cases) - Compare symptom onset date to ensure same day as
        #                                           or before positive test result (cases only)
    
         symp_gt_test_date_f = fct_relevel(as_factor(case_when(caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date >= test_result_date) ~ "Yes",
                                                               caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date < test_result_date) ~ "No",
                                                               caco == "Control"                     ~ "Not applicable, control",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No", "Not applicable, control"),
        
        # Clinic Visit Date – HD vs Self Report (Controls) - Compare  clinic visit as reported from HD compared to self-report 
        #                                                    Flag if (clinic_date - control_visit_date) > +/- 2
         clinic_v_control_date = fct_relevel(as_factor(case_when(!is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) > 20) ~ "Abs > 20 days: Yes",
                                                                 !is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) <= 20) ~ "Abs > 20 days: No",
                                                                 TRUE ~ as.character(NA))),
                                             "Abs > 20 days: Yes", "Abs > 20 days: No"),
    #==== DQ Check: Vaccination variables ----
           
          # Dose 1 and Dose 2 Vaccination Interval (self-report) - Flag interval < 24 days and > 24 days to ID implausible intervals
          dose_int_self = ifelse(!is.na(first_dose_date) & !is.na(second_dose_date), second_dose_date - first_dose_date, NA), 
          dose_int_cat_self = fct_relevel(as_factor(case_when(first_dose_yesno != 1                                   ~ "Not Vaxed",
                                                                !is.na(first_dose_date) & is.na(second_dose_date)    ~ "Dose #1 only",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) < 24)        ~ "<24 days",
                                                             !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  (((second_dose_date - first_dose_date) %in% c(24:28)))  ~ "24-28 days",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) > 28)            ~ ">28 days",
                                                             TRUE ~ as.character(NA))),
                                       "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"),
           
         
    
          # site-report: Dose 1 and Dose 2 Vaccination Interval - Flag interval < 24 days and > 24 days to ID implausible intervals
         dose_int_site = ifelse(!is.na(dose1_date) & !is.na(dose2_date), dose2_date - dose1_date, NA),
         dose_int_cat_site = fct_relevel(as_factor(case_when(dose1_yesno != 1                             ~ "Not Vaxed",
                                                              !is.na(dose1_date) & is.na(dose2_date)      ~ "Dose #1 only",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) < 24)          ~ "<24 days",
                                                           !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                  (((dose2_date - dose1_date) %in% c(24:28)))  ~ "24-28 days",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) > 28)          ~ ">28 days",
                                                           TRUE ~ as.character(NA))),
                                         "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"
                                                           ),
        # Vaccine Dose Number – HD vs Self Report: Compare number of vaccine doses reported from HD compared to self-report
          site_v_self_dose1 = fct_relevel(as_factor(case_when((dose1_yesno == 1 & first_dose_yesno == 1) |
                                                                (dose1_yesno == 0 & first_dose_yesno == 0) ~ "Same",
                                                              (dose1_yesno == 1 & first_dose_yesno == 0)   ~ "Site-Vax",
                                                              (dose1_yesno == 0 & first_dose_yesno == 1)   ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
          site_v_self_dose2 = fct_relevel(as_factor(case_when((dose2_yesno == 1 & second_dose_yesno == 1) |
                                                                (dose2_yesno == 0 & second_dose_yesno == 0) ~ "Same",
                                                              (dose2_yesno == 1 &
                                                                 (second_dose_yesno == 0 | is.na(second_dose_yesno)))   ~ "Site-Vax",
                                                              ((dose2_yesno == 0 | is.na(dose2_yesno)) &
                                                                 second_dose_yesno == 1)  ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
    
       # Vaccine Administration Date – HD vs Self Report: Compare dates of vaccination administration between
       #                                                  HD and self-report (add +/- 1 or 2 days)
    
        site_v_self_vaxdate1 = fct_relevel(as_factor(case_when(!is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) > 2) ~ "Abs > 2: Yes",
                                                               !is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) <= 2) ~ "Abs > 2: No",
                                                               TRUE ~ as.character(NA))),
                                         "Abs > 2: Yes", "Abs > 2: No"),
       
       site_v_self_vaxdate2 = fct_relevel(as_factor(case_when(!is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) > 2) ~ "Abs > 2: Yes",
                                                              !is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) <= 2) ~ "Abs > 2: No",
                                                              TRUE ~ as.character(NA))),
                                          "Abs > 2: Yes", "Abs > 2: No"),
    # Prior Smallpox Vaccination Timing flag
           smallpox_birth_f = fct_relevel(as_factor(case_when((priorvax == 1 & (birth_year < priorvax_year)|
                                                                priorvax %in% c(2:3)) ~ "Plausible",
                                                              priorvax == 1 & (birth_year > priorvax_year) ~ "Implausible",
                                                              priorvax == 1 & is.na(birth_year) ~ "birth year missing",
                                                              priorvax == 1 & is.na(priorvax_year) ~ "Vax year missing",
                                                            TRUE ~ as.character(NA))),
                                        "Plausible", "Implausible", "birth year missing", "Vax year missing"),

      #==== Clean analysis variables ----
       # Check to make sure birth year is within range of a person being between 18-49 years old
       #               Invalid birth years/ages should be captured via REDCap checks, except for some unusual
       #                situations which should be reviewed and resolved on a case-by-case basis 
              # Calculate age based on birth year and symptom or clinic date
              age = year(index_date) - birth_year,
              # Flag if submitted date– birth_year <18 | > 49 (AOD: we do not have submitted date) 
              age_f = fct_relevel(as_factor(case_when(age < 18          ~ "<18",
                                                            age %in% c(18:49) ~ "18-49",
                                                            age > 49          ~ "\u226550",
                                                            TRUE ~ as.character(NA))),
                                        "<18", "18-49", "\u226550"),
              # Age categorical
              age_cat = fct_relevel(as_factor(case_when(age %in% c(18:29) ~ "18-29",
                                                        age %in% c(30:39) ~ "30-39",
                                                        age >=40 ~ "40-49",
                                                            TRUE ~ as.character(NA))),
                                        "18-29", "30-39", "40-49"),
  
          
    
           #categorical race variable
            race_cat = fct_relevel(as_factor(case_when((race___1 == 1 & race___2 == 0 & race___3 == 0 &
                                                         race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "African American or Black",
                                                       (race___1 == 0 & race___2 == 1 & race___3 == 0 &
                                                         race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "White",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 1 &
                                                          race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "Asian",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 1 & race___5 == 0 & race___6 == 0) ~ "Native Hawaiin/Pacific Islander",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 0 & race___5 == 1 & race___6 == 0) ~ "American Indian/Alaska Native", 
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 0 & race___5 == 0 & race___6 == 1) ~ "Prefer not to answer",
                                                       (race___1 == 1 | race___2 == 1 | race___3 == 1 |
                                                          race___4 == 1 | race___5 == 1 | race___6 == 1) ~ "Multiracial",
                                                       TRUE ~ NA_character_)), 
                                   "African American or Black", "White", "Asian",
                                   "Native Hawaiin/Pacific Islander", "American Indian/Alaska Native", "Prefer not to answer",
                                   "Multiracial"),


            #race-ethnicity: ethnicity (1, Hispanic or Latino | 2, Not Hispanic or Latino | 3, Prefer not to answer)
            race_ethn_cat = fct_relevel(as_factor(case_when(ethnicity == 1 ~ "Hispanic",
                                                        race_cat == "White" ~ "White",
                                                        race_cat == "African American or Black" ~ "Black",
                                                        race_cat == "Asian" ~ "Asian",
                                                        race_cat == "Native Hawaiin/Pacific Islander" ~ "Native Hawaiin/Pacific Islander",
                                                        race_cat == "American Indian/Alaska Native" ~ "American Indian/Alaska Native",
                                                        race_cat == "Multiracial" ~ "Multiracial",
                                                        
                                                        TRUE ~ as.character("Other"))),
                                        "Black", "White", "Hispanic", "Asian",
                                   "Native Hawaiin/Pacific Islander", "American Indian/Alaska Native", "Multiracial", "Other"),
  
            race_ethn = fct_relevel(as_factor(case_when(ethnicity == 1 ~ "Hispanic",
                                                        race_cat == "White" ~ "White",
                                                        race_cat == "African American or Black" ~ "Black",
                                                        TRUE ~ as.character("Other"))),
                                        "Black", "White", "Hispanic", "Other"),
  
  
  
  # Length of Hospitalization - Examine if length of days of hospitalization is longer than
          #                             the time between illness onset and survey submission
          #                             Flag if hospitalized_days > (submitted date - symptoms_date)
          #!                            AOD: We do not have a submitted date variable at CDC as the sites
          #!                                are not uploading the time stamps. However, only 2 people reported
          #!                                being hospitalized and their days of hospitalization (3 & 13) seem plausible.
         hospitalized_cat = fct_relevel(as_factor(case_when(hospitalized == 0 ~ "No",
                                                            hospitalized == 1 ~ "Yes",
                                                            TRUE ~ as.character(NA))),
                                        "Yes", "No"),
         hospitalized_days_cat = fct_relevel(as_factor(case_when(hospitalized_days == 0         ~ "0",
                                                                  hospitalized_days %in% c(1:7)   ~ "1-7",
                                                                  hospitalized_days %in% c(8:14)  ~ "8-14",
                                                                  hospitalized_days %in% c(15:21) ~ "15-21",
                                                                  hospitalized_days %in% c(22:28) ~ "22-28",
                                                                  hospitalized_days >= 29         ~ "\u226529",
                                                                  TRUE ~ as.character(NA))),
                                              "0", "1-7","8-14", "15-21", "22-28", "22-28", "\u226529"),
    
          # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #           AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls                    #                                categorization included below.
          
        immunocompromised = fct_relevel(as_factor(case_when(hiv_status == 1 | immune_response ==  1 ~ "Yes",
                                                            TRUE ~ as.character("No"))),
                                        "Yes", "No"),
    # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #                   AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls                     
          sex_part_num = ifelse(caco == "Case", sex_part_num_case, 
                               ifelse(caco == "Control", sex_part_num_control, NA)),
          sex_part_num_cat = fct_relevel(as_factor(case_when(sex_part_num == 0 ~ "0",
                                                            sex_part_num == 1 ~ "1",
                                                            sex_part_num == 2 ~ "2",
                                                            sex_part_num == 3 ~ "3",
                                                            sex_part_num >= 4 ~ "\u22654",
                                                            TRUE ~ as.character(NA))),
                                         "0", "1", "2", "3", "\u22654"),
      
           
      
    # Flag those who reported having experienced mpox symptoms and specified one of the listed symptoms 
             symptom_type_complete = ifelse(symptoms_yesno == 1 &
                                                 if_any(contains("symptom_type___"), ~ . == 1),
                                               1,
                                               ifelse(symptoms_yesno == 1 &
                                                         if_all(contains("symptom_type___"), ~ . == 0),
                                                       0, NA)),

      # Mpox exposure history: contacts
  
        close_contact_dx = case_when(caco == "Case" & !is.na(contact_mpx_dx_case) ~ contact_mpx_dx_case,
                                     caco == "Case" & 
                                       (is.na(contact_mpx_dx_case) & 
                                          !is.na(contact_mpx_dx_control)) ~ contact_mpx_dx_control,
                                     caco == "Control" & !is.na(contact_mpx_dx_control) ~ contact_mpx_dx_control,
                                     caco == "Control" & 
                                       (is.na(contact_mpx_dx_control) & 
                                          !is.na(contact_mpx_dx_case)) ~ contact_mpx_dx_case,
                                     TRUE ~ as.numeric(3)),
      close_contact_dx_cat = fct_relevel(as_factor(case_when(close_contact_dx == 1 ~ "Yes",
                                                             close_contact_dx == 2 ~ "No",
                                                             close_contact_dx == 3 ~ "Don't know",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No","Don't know")
  
      # time period matching
      # close ------
       
            ) %>% 
  select(pid, jid, everything(), -redcap_data_access_group) 
      
  #export as csv 
      
      # analysis <- mpoxve %>% 
      #   filter(minset_vars == "Complete")
      # write.csv(analysis, "data/mpoxve_analysis_2023-02-09.csv")
   
      
```

## **Part 1: Key data elements and case status**

In part 1, we examine missingness patterns of the key data elements, especially those that are related to case and control classification.

### Minimum set of data elements needed for VE estimation: Components

1.  Site case status classification

2.  Index date:

    -   *Cases:* Test result date ≥ August 19, 2022. If the test result date is missing or before August 19, 2022, use symptom onset date ≥ August 19, 2022.
    -   *Controls:* Self-reported clinic date ≥ August 19, 2022. If the self-reported clinic date is missing or before August 19, 2022, use site-reported clinic date ≥ August 19, 2022.

3.  Vaccination:

    -   Dose #1: Use site-reported variables (dose1_yesno & dose1_date) to create vax1_yesno and vax1_date. If the site-reported variables are missing or site reported no vaccination then use self-reported variables (first_dose_yesno and first_dose_date).
    -   Dose #2: if vax1_yesno and vax1_date are complete, then use the site-reported variables (dose2_yesno & dose2_date) to create vax2_yesno and vax2_date. If the site-reported variables are missing or site reported no vaccination then use self-reported variables (second_dose_yesno and second_dose_date).

### Distribution of complete minimum set of data elements

**Table 1. Distribution of respondents with a minimum set of data elements**

```{r}
mpoxve %>% 
  #filter(!is.na(caco_stat_cat)) %>% 
  select(jid, minset_vars) %>% 
  tbl_summary(
    by = jid,
    label = list(minset_vars ~ "Min data elements")
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()

```

**Figure 1. Missingness patterns across a the set of minimum data elements**

```{r}
mpoxve %>% 
  select(case_yesno, index_date, vax1_yesno, vax1_date, vax2_yesno, vax2_date)%>%
  gg_miss_upset()

```

### Distribution of case status

**Figure 2. Case definition**

![](screenshots/case_def_2023-02-03.png)

**Table 2. Case status**

```{r}
mpoxve %>% 
  select(jid, caco_stat_cat,  caco, caco_sen) %>% 
  tbl_summary(
    by = jid,
    label = list(caco_stat_cat ~ "All categories",
                 caco ~ "Main VE analysis",
                 caco_sen ~ "Sensitivity VE analysis"),
    missing = "always",
    missing_text = "Missing"
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  modify_header(label = "**Case status**") %>% # update the column header
  bold_labels()
```

### Distribution of site-reported clinic visit versus vaccine dose dates

**Table 3. Respondent with same clinic dates versus vaccination dates**

```{r}

mpoxve %>% 
  mutate(clinic_vax_date = fct_relevel(as_factor(case_when(control_visit_date == dose1_date ~ "Clinic = D1",
                                                           control_visit_date == dose2_date ~ "Clinic = D2",
                                                           TRUE ~ as.character(NA))),
                                       "Clinic = D1", "Clinic = D2")) %>% 
  filter(!is.na(clinic_vax_date)) %>%
  select(jid, clinic_vax_date) %>% 
  tbl_summary(
    by = jid,
    label = list(clinic_vax_date ~ "Dates"),
    missing = "no"
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()
  

```

**Table 4. List of respondent with same clinic dates versus vaccination dates**

```{r}

clinic_vax <- mpoxve %>% 
  mutate(clinic_vax_date = fct_relevel(as_factor(case_when(control_visit_date == dose1_date ~ "Clinic = D1",
                                                           control_visit_date == dose2_date ~ "Clinic = D2",
                                                           TRUE ~ as.character(NA))),
                                       "Clinic = D1", "Clinic = D2")) %>% 
  filter(!is.na(clinic_vax_date)) %>%
  select(pid, caco_stat_cat, clinic_vax_date, case_yesno, vax_stat, index_date, clinic_date, control_visit_date, dose1_date, dose2_date) %>% 
  arrange(clinic_vax_date)


#clipr::write_clip(clinic_vax) 

clinic_vax %>% 
     DT::datatable(., extensions='Buttons',
                     options = list(
                       searching = T,
                       pageLength = 10,
                       dom = 'Bfrtip',
                       buttons = c('csv')))
  

```

## **Part 2: Vaccination Status**

**Definitions:**

-   [Fully vaccinated:]{.underline} Receipt of two doses of JYNNEOS vaccine at least 24 days apart, with the second dose having been administered \>13 days before index date (mpox symptom onset [for cases] or clinic visit date [for controls]).

-   [Partially vaccinated:]{.underline} Receipt of one dose of JYNNEOS vaccine \>13 days before index date or respondents with receipt of two doses of JYNNEOS vaccine \<14 days before index date.

-   [PEP vaccination]{.underline}: Receipt of one dose of JYNNEOS vaccine within 13 days after exposure to a person diagnosed with mpox (confirmed or probable case) and before index date.

-   [Unvaccinated:]{.underline} Without receipt of any doses of JYNNEOS vaccine or receipt of the vaccine after index date

**Figure 2. Dose #1 (D1), dose #2 (D2), and index event (IE) date scenarios**

![](screenshots/vax_def_2023-02-03.png)

**Table 5. Distribution of vaccination status among those with a complete minimum data elements**

```{r}
mpoxve %>%
  filter(minset_vars == "Complete") %>% 
  select(caco, vax_stat, vax_stat_ve, pep_stat_ve) %>% 
  tbl_summary(
    by = caco,
    label = list(vax_stat ~ "Descriptive table",
                 vax_stat_ve ~ "Main VE analysis*",
                 pep_stat_ve ~ "PEP VE analysis"
                 
                 ),
     #percent = "column",
    missing = "always",
    missing_text = "Missing"
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels() %>% 
  as_gt() %>%
  gt::tab_source_note(gt::md("*Missing = those exculded in scenario 3 & 5"))

```

### **Table 10. VE model adjustment variables **

```{r}

mpoxve %>%
  filter(minset_vars == "Complete") %>%
  select(caco, age, age_cat, race_ethn, sex_part_num_cat, index_yrmo, close_contact_dx_cat) %>%
  tbl_summary(
    by = caco,
    # label = list(why_vax___1 ~ "Exposed and dose w/in 13d",
    #              why_vax___2 ~ "High risk of mpox",
    #              why_vax___3 ~ "Work exposure"),
    missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels()

```

<!-- ### **Table 11. VE model adjustment variables ** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->
<!--   filter(minset_vars == "Complete" & jid == "MN") %>% -->
<!--   select(caco, index_yrmo) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(index_yrmo ~ "Year-Month"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>%  -->
<!--   modify_header(label = "**Minnesota: time period match**") %>% -->
<!--   bold_labels() -->



<!-- ``` -->

<!-- ## **Part 3: Vaccination related variables**  -->

<!-- We restricted the tables below to those with complete set of minimum data elements. -->

<!-- ### **Table 6. Dose 1 and Dose 2 vaccination interval: site & self** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--   filter(minset_vars == "Complete") %>% -->
<!--   select(caco, dose_int_cat_site, dose_int_cat_self) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(dose_int_cat_site ~ "Site", -->
<!--                  dose_int_cat_self ~ "Self"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->

<!-- ### **Table 7. Vaccine dose number: site versus self** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--   filter(minset_vars == "Complete") %>% -->
<!--   select(caco, site_v_self_dose1, site_v_self_dose2) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(site_v_self_dose1 ~ "Dose #1", -->
<!--                  site_v_self_dose2 ~ "Dose #2"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->

<!-- ### **Table 8. Vaccine administration date: site versus self (+/- 2 days)** -->

<!-- ```{r} -->
<!-- mpoxve %>% -->
<!--   filter(minset_vars == "Complete") %>% -->
<!--   select(caco, site_v_self_vaxdate1, site_v_self_vaxdate2) %>% -->
<!--   tbl_summary( -->
<!--     by = caco, -->
<!--     label = list(site_v_self_vaxdate1 ~ "Dose #1", -->
<!--                  site_v_self_vaxdate2 ~ "Dose #2"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->

<!-- ``` -->

<!-- ### **Table 9. Reasons for getting vaccinated by vaccination status categories ** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->
<!--   filter(minset_vars == "Complete") %>% -->
<!--   select(vax_stat, why_vax___1, why_vax___2, why_vax___3, ) %>% -->
<!--   tbl_summary( -->
<!--     by = vax_stat, -->
<!--     label = list(why_vax___1 ~ "Exposed and dose w/in 13d", -->
<!--                  why_vax___2 ~ "High risk of mpox", -->
<!--                  why_vax___3 ~ "Work exposure"), -->
<!--     missing = "always", -->
<!--     missing_text = "Missing" -->

<!--   )  %>% -->
<!--   add_n() %>% -->
<!--   add_overall() %>% -->
<!--   bold_labels() -->


<!-- ``` -->

<!-- ### **Table . Reasons for getting vaccinated by vaccination status categories ** -->

<!-- ```{r} -->

<!-- tt <- mpoxve %>% -->
<!--   filter(minset_vars == "Complete") %>% -->
<!--   mutate(dose1index_days_self = index_date - first_dose_date) %>%  -->
<!--   pfreq(caco, vax_stat, why_vax___1, index_date, vax1_date, dose1index_days, first_dose_date, dose1index_days_self) %>%  -->
<!--   filter(why_vax___1 == 1) -->

<!-- clipr::write_clip(tt) -->

<!-- library(tableone) -->
<!--  mpoxve_pep<- mpoxve %>% -->
<!--     mutate(why_vax_pep = fct_relevel(as_factor(case_when(why_vax___1 == 1 ~ "Yes", -->
<!--                                                          why_vax___1 == 0 ~ "No", -->
<!--                                                          TRUE ~ as.character(NA))), -->
<!--                                      "Yes", "No")) -->
<!-- cov_names <- names(mpoxve_pep %>%  -->
<!--                      select(caco, vax_stat, why_vax_pep)) -->

<!-- tbl1_vars <- cov_names -->


<!-- tbl1_strata <- c("caco", "vax_stat") -->
<!-- tbl1_factorvars <- tbl1_vars -->
<!-- # Crude ------------------------------ -->
<!--   tbl_crude <- CreateTableOne(data = mpoxve_pep,                            -->
<!--                               vars = tbl1_vars, -->
<!--                               strata = tbl1_strata,  -->
<!--                               factorVars = tbl1_factorvars) -->

<!--   tbl_crude_print <- print(tbl_crude, showAllLevels = T, quote = FALSE, smd = F, -->
<!--                            noSpaces = TRUE, test = F, printToggle = FALSE, -->
<!--                            nonnormal = tbl1_nonnormal, formatOptions = list(big.mark = ",")) %>%  -->
<!--     as.data.frame() %>%  -->
<!--       filter(level %in% c("Yes", "No")) %>%  -->
<!--     rename(`Exposed and dose w/in 13d` = level)  -->

<!-- clipr::write_clip(tbl_crude_print) -->
<!-- ``` -->




<!-- ## **Part 4: Plausibility of key dates (non-vaccination)** -->

<!-- In Part 4, we explore explore the plausibility of key dates. We restrict the analysis to respondents with per protocol case status definition before apply additional restrictions where necessary. -->

<!-- ### **Symptom Onset Date vs Test Date (Cases)** -->

<!-- How should we handle these 11 records where the symptom onset date is after the positive test result? -->

<!-- **Table 15. list of cases with symptom onset date after positive test result** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--   filter(caco == "Case" & index_date_na == "Complete" & symp_gt_test_date_f == "Yes") %>%  -->

<!--   select(pid, symptoms_date, test_result_date) %>% -->

<!--   DT::datatable(., extensions='Buttons', -->

<!--                      options = list( -->

<!--                        searching = T, -->

<!--                        pageLength = 10, -->

<!--                        dom = 'Bfrtip', -->

<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Clinic visit date---site vs Self report (controls)** -->

<!-- Flag if records with the absolute difference in days between the site and self-reported clinic date is \>2. Among the 60 records with the absolute difference in days between the site and self-reported clinic date is \>2, there are 20 records with an absolute difference in days \>28 days. What should we do with this? -->

<!-- **Table 16. list of controls with absolute difference in days between the site and self-reported clinic date is \>2** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--   filter(caco == "Control" & clinic_v_control_date == "Abs > 20: Yes") %>% # restrict to per protocol definition of case status = cases -->

<!--   select(pid, control_visit_date, clinic_date) %>% -->

<!--    DT::datatable(., extensions='Buttons', -->

<!--                      options = list( -->

<!--                        searching = T, -->

<!--                        pageLength = 10, -->

<!--                        dom = 'Bfrtip', -->

<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Smallpox vaccination year** -->

<!-- **Table 17. Smallpox vaccination timing** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(index_date_na == "Complete") %>%  -->

<!--   select(caco, smallpox_birth_f) %>% -->

<!--   tbl_summary( -->

<!--     by = caco, -->

<!--     label = list(smallpox_birth_f ~ "Smallpox"), -->

<!--     missing = "always", -->

<!--     missing_text = "Missing" -->

<!--   )  %>% -->

<!--   add_n() %>% -->

<!--   add_overall() %>% -->

<!--   bold_labels() -->

<!-- ``` -->

<!-- ## **Part 5: Age, hospitalization, and number of sexual partners** -->

<!-- ### **Age** -->

<!-- **Table 18. Distribution of age** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->

<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->

<!--   filter(is.na(caco) == F) %>% -->

<!--   select(caco, age_f, age_cat) %>% -->

<!--   tbl_summary( -->

<!--     by = caco, -->

<!--     label = list(age_f ~ "Age", -->

<!--                  age_cat ~ "Age Distribution"), -->

<!--     missing = "always", -->

<!--     missing_text = "Missing" -->

<!--   )  %>% -->

<!--   add_n() %>% -->

<!--   add_overall() %>% -->

<!--   bold_labels() -->

<!-- ``` -->

<!-- **Table 16. List of respondents missing birth year** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->

<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->

<!--   filter(is.na(caco) == F) %>% -->

<!--   filter(is.na(age))%>% -->

<!--   select(caco, pid, index_year, birth_year, symptoms_date, test_result_date, control_visit_date, clinic_date)  %>% -->

<!--   rename(PID = pid, `Birth year` = birth_year) %>% -->

<!--   DT::datatable(., extensions='Buttons', -->

<!--                      options = list( -->

<!--                        searching = T, -->

<!--                        pageLength = 10, -->

<!--                        dom = 'Bfrtip', -->

<!--                        buttons = c('csv'))) -->

<!-- ``` -->

<!-- ### **Length of hospitalization** -->

<!-- For the length of Hospitalization, we want to examine if length of days of hospitalization is longer than the time between illness onset and survey submission (flag if hospitalized_days \> (submitted date - symptoms_date). However, we do not have a 'submitted date' variable at CDC as the sites are not uploading the time stamps. However, only 4 people reported being hospitalized and their days of hospitalization seem plausible. *Note*: Length of hospitalization was assessed among those who self-reported as having been told by a provider they have mpox. -->

<!-- **Table 16. Distribution of hospitalization** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->

<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->

<!--   filter(caco == "Case") %>% -->

<!--   select(hospitalized_cat, hospitalized_days_cat) %>% -->

<!--   tbl_summary( -->

<!--     label = list(hospitalized_cat ~ "Hospital", -->

<!--                  hospitalized_days_cat ~ "Days hospitalized" ), -->

<!--     missing = "always", -->

<!--     missing_text = "Missing" -->

<!--   )  %>% -->

<!--   add_n() %>% -->

<!--   bold_labels() -->

<!-- ``` -->

<!-- ### **Number of sexual partners** -->

<!-- For the number of sexual partners, we want to examine the distribution of number of sexual partners for any implausible values. What values should we consider as implausible? -->

<!-- **Table 17. Distribution of sexual partners** -->

<!-- ```{r} -->

<!-- mpoxve %>% -->

<!--    filter(#Exclude records without site-reported or self-reported case status information (the majority of these are from TN), -->

<!--          (is.na(caco_stat_match_f) | minset_vars_self == "Incomplete") == F) %>% -->

<!--   filter(is.na(caco) == F) %>% -->

<!--   select(caco, sex_part_num, sex_part_num_cat) %>% -->

<!--   tbl_summary( -->

<!--     by = caco, -->

<!--     label = list(sex_part_num ~ "# sexual partners", -->

<!--                  sex_part_num_cat ~ "# sexual partners" -->

<!--                  ), -->

<!--     missing = "always", -->

<!--     missing_text = "Missing" -->

<!--   )  %>% -->

<!--   add_n() %>% -->

<!--   add_overall() %>% -->

<!--   bold_labels() -->

<!-- ``` -->

**List of respondents and their exposure and outcome classification**

```{r}

data_check <- mpoxve %>%

  select(jid, pid, caco, caco_stat_cat, case_yesno, provider_dx, index_date, test_result_date, symptoms_yesno, symptoms_date,

         clinic_yesno, clinic_date, control_visit_date,

         vax_stat, vax1_yesno, vax1_date, dose1_yesno, dose1_date,

         first_dose_yesno, first_dose_date,

         vax2_yesno, vax2_date, dose2_yesno, dose2_date, second_dose_yesno,

         second_dose_date) %>%

  mutate(case_yesno = fct_relevel(as_factor(case_when(case_yesno == 1 ~ "1-Confirmed",

                                                      case_yesno == 2 ~ "2-Probable",

                                                      case_yesno == 3 ~ "3-Control",

                                                      TRUE ~ as.character(NA))),

                                  "1-Confirmed", "2-Probable", "3-Control"),

         provider_dx = fct_relevel(as_factor(case_when(provider_dx == 0 ~ "2-No",

                                                       provider_dx == 1 ~ "1-Yes",

                                                       TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         clinic_yesno = fct_relevel(as_factor(case_when(clinic_yesno == 0 ~ "2-No",

                                                       clinic_yesno == 1 ~ "1-Yes",

                                                       TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         symptoms_yesno = fct_relevel(as_factor(case_when(symptoms_yesno == 0 ~ "2-No",

                                                          symptoms_yesno == 1 ~ "1-Yes",

                                                       TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         dose1_yesno = fct_relevel(as_factor(case_when(dose1_yesno == 0 ~ "2-No",

                                                       dose1_yesno == 1 ~ "1-Yes",

                                                       TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         dose2_yesno = fct_relevel(as_factor(case_when(dose2_yesno == 0 ~ "2-No",

                                                       dose2_yesno == 1 ~ "1-Yes",

                                                       TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         first_dose_yesno = fct_relevel(as_factor(case_when(first_dose_yesno == 0 ~ "2-No",

                                                            first_dose_yesno == 1 ~ "1-Yes",

                                                            TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         second_dose_yesno = fct_relevel(as_factor(case_when(second_dose_yesno == 0 ~ "2-No",

                                                             second_dose_yesno == 1 ~ "1-Yes",

                                                             TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         vax1_yesno = fct_relevel(as_factor(case_when(vax1_yesno == 0 ~ "2-No",

                                                      vax1_yesno == 1 ~ "1-Yes",

                                                      TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         vax2_yesno = fct_relevel(as_factor(case_when(vax2_yesno == 0 ~ "2-No",

                                                      vax2_yesno == 1 ~ "1-Yes",

                                                      TRUE ~ as.character(NA))),

                                  "1-Yes", "2-No"),

         excluded = fct_relevel(as_factor(case_when(is.na(index_date) |

                                                      (vax1_yesno == 1 & is.na(vax1_date)) |

                                                      is.na(caco)~ "Yes",

                                                    TRUE ~ as.character("No"))),

                                  "Yes", "No")) %>%

  arrange(jid, caco_stat_cat) %>%

  select(excluded, everything(), -caco, -jid)

# %>%

#   filter(excluded == "Yes")

clipr::write_clip(data_check)

vax_clinic_date <- data_check %>%

  filter(control_visit_date == dose1_date | control_visit_date == dose2_date) %>%

  select(excluded, pid, caco_stat_cat, case_yesno, index_date, clinic_date, control_visit_date, dose1_date, dose2_date)

tt <- data_check %>%

  filter(case_yesno %in% c("1-Confirmed", "2-Probable") & provider_dx == "2-No") %>%

  select(excluded, pid, caco_stat_cat, case_yesno, provider_dx, symptoms_yesno, test_result_date, symptoms_date, clinic_yesno, clinic_date, control_visit_date)

```
