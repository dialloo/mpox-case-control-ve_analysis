---
title: "Preliminary Results: Post-Manual Reveiw" 
subtitle: "2022 Mpox Multi-Jurisdictional Case-Control VE Public Health Evaluation"
author: "Report by Case-Control Unit | VE Team | VTF | 2022 Multinational Monkeypox Response"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
  # html_document:
    code_folding: hide
    highlight: tango
    #toc: yes
    toc_depth: 3
    #toc_float: yes
    editor_options:
      chunk_output_type: console
      canonical: true
      
    # word_document:
    # reference_docx: "template.docx"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## **Report objectives**

1.  Clean vaccination status scenarios and index date based on the manual review of vaccination status after the February 2023 ACIP meeting.

    -   Examine why the IE for some cases were based on site-reported clinic date, which is for controls.

    -   Reclassify records with vaccine status scenario (S) 6 as S4 if dose (D) 2 is \<= 0 day (d) before the index date (IE).

    -   Use self-reported D1 & D2 for respondents with self-reported D1 & D2, but only site-reported D1.

    -   Compare vaccine status scenario from the manual review with the re-coded vaccination status scenarios.Â 

2.  Output the following tables and results:

    -   Distribution of variables under consideration in the models by case status

    -   Distribution of participant characteristics by case and vaccination status

    -   Epi curve index event dates

    -   VE model results

```{r libraries, message = FALSE, warning = FALSE}


# Load packages --------------------------------
  pacman::p_load(here,        # file paths relative to R project root folder
                 rio,         # import/export
                 readxl,      # read excel files
                 tidyverse,    # data management and visualization
                 purrr,        # iteration
                 janitor,      # data management: cleaning and exploring data
                 lubridate,    # working with dates/epiweeks
                 naniar,       # Working with data structures, summaries, and visualizations for Missing Data
                 arsenal,      # provides unctions for large-scale statistical summaries
                 ggsci,        # scientific journal and sci-fi themed color palettes for 'ggplot2'
                 cowplot,      # streamlined plot theme and plot annotations for 'ggplot2'
                 knitr,        # Provides a general-purpose tool for dynamic report generation in R
                 kableExtra,   # simplifies the way to manipulate the HTML or 'LaTeX' codes generated by 'kable()
                 DT,           # provides an R interface to the JavaScript library DataTables
                 gtsummary,    # publication-ready analytical and summary tables
                 tableone,     # Creates 'Table 1', i.e., description of baseline patient characteristics
                 stargazer,    # provides a way to create publication quality tables
                 plotly,        # creates interactive web-based graphs 
                 geepack,
                 broom,
                 sjPlot,   # to visualizing mixed-effects models
                 effects,   # to visualizing mixed-effects models
                 lme4,      # "golden standard" for mixed-effects modelling in R (no p-values,
                 lmerTest,  # p-values for MEMs based on the Satterthwaite approximation
                 report,    # mainly for an "report" function
                 emmeans,   # post-hoc analysis
                 splines,
                 knitr,     # beautifying tables
                 sjstats,   # ICC - intraclass-correlation coefficient
                 caret,     # ML, model comparison & utility functions
                 aweek,        # alternative package for working with dates/epiweeks
                 incidence2,   # epicurves of linelist data
                 i2extras,     # supplement to incidence2
                 MMWRweek     # Convert Dates to MMWR Day, Week, and Year

                 
  )

# Global option number format
  options(scipen = 9999)

#GT Table Theme
  theme_gtsummary_journal(journal = "jama")
  theme_gtsummary_compact()
# Helper (custom functions) ------------------------------------------------------------
#This function replicates the SAS proc freq function with the '/ list missing statement'. 
#Source: https://github.com/asnr/sas-to-r
pfreq = function(...) {
  dplyr::group_by(...) %>%
    dplyr::summarize(n = n()) %>%
    dplyr::mutate(pct= round(100 * n/sum(n), 1)) 
  #mutate(Percent=paste0(round(100 * n/sum(n), 1), "%")) 
}

# This function helps create consistent values for Yes/No variables.
# by reassigning '2' values a zero. 
give_two_a_zero <- function(x){
  x[x == 2 ] <- 0
  x
}


# Source data and define environment variables ---------------------------------------------------------------------

  source("00_REDCap-API-linkage.R", local =knit_global())

  # raw <- here("data", "MultiJurisdictionalM_DATA_2023-03-06_1448.csv") %>%
  # read_csv()

  # Manual review results 

    mr <- here("data", "mpoxve_manual_review_combined_aod.xlsx") %>% 
      read_excel(sheet = "with_pid") %>% 
      rename_with(function(x) paste0("mr_", x), -pid)%>% 
      mutate(mr = 1) %>% 
      select(mr, pid, everything())

  # Environment variables for Rmarkdown purpose
    # This the date of the earliest symptom per the study protocol
    
      eligibility_date_v2 <- "19 Aug 2022"
  
    # This date represent the most recent data transfer from jurisdictions
    
      redcap_trans_date_v2 <- "06 Mar 2023"

# Tidy data ----------------------------------------------------------------------
mpoxve <- raw %>%
    # Restrict to eligible respondents (i.e., those that passed the eligibility screening)
    filter(inelig_stop ==  1) %>% 
    # Restrict to those who have data for relevant eligibility screening questions 
    filter(!if_all(c(elig_age, elig_sexuality, elig_gender,
                     elig_gender_msm, elig_sexual_partners,
                     elig_healthcare), is.na)) %>%
    # filter(redcap_data_access_group == "nyc" & consent == 1) %>%
    # select(pid, case_yesno, provider_dx, test_result_date, symptoms_yesno, symptoms_date, control_visit_date, dose1_yesno, dose1_date, dose2_yesno, dose2_date, clinic_yesno, clinic_date) %>% 
    #     filter(is.na(case_yesno) & provider_dx == 1)
    left_join(mr, by = c("pid")) %>% 
    mutate(#! Variable name key: 
               #!  *_cat: indicates a categorical these are flags (0/1)
               #!  *_f: these are flags (0/1)
               #!  *_na: these are also flags but specifically related to missingness (NA = missing in R)
               #!  *_int: these refer to some calculate interval
               #!  pd: an abbreviation for period
          
            mr = ifelse(is.na(mr), 0, mr),
          
    #==== General variable cleaning ----
           # Format all yes/no variables with 1(Yes)/2(No) values as 1(Yes)/0(No).
           across(contains(c("elig_age", "elig_gender_msm", "elig_sexual_partners",
                             "elig_healthcare", "first_dose_yesno", "second_dose_yesno",
                             "symptoms_yesno", "provider_dx", "clinic_yesno", "hospitalized",
                             "dose1_yesno", "dose2_yesno"), ignore.case = TRUE), give_two_a_zero),
           
           # Format all date variables as YYYY-MM-DD
           across(contains("_date", ignore.case = TRUE), ymd),

    
           # Check the presence of a jurisdiction ID
           juris_detect = case_when(str_detect(pid, "CA_|CO_| CT_|DC_|GA_|LAC_|MD_|MN_|NYC_|NYS_|NYR_|OR_|TN_") ~ 1,
                           TRUE ~ as.numeric(0)),

           # Rename REDCap Data Access Group variable and capitalize the letters
           jid = fct_relevel(as_factor(toupper(redcap_data_access_group)),
                             "CA", "LAC", "CO", "CT", "GA", "MD", "MN",
                             "NYS", "NYC", "OR", "TN", "DC"),

    #==== Index date (mpox symptom onset [for cases] or clinic visit date [for controls]) ----
    
         # Create a study period variable to store mpox symptoms date within 2022-08-19 and most recent data transfer 
          eligibility_date = ymd("2022-08-19"),
          redcap_trans_date = ymd("2023-03-06"),
    
          study_pd_int = interval(eligibility_date, redcap_trans_date),
    
          index_date = case_when(test_result_date %within% study_pd_int ~ test_result_date,
                                  ((is.na(test_result_date) | #if incomplete or
                                     (test_result_date < eligibility_date)) & # before Aug 19 
                                       (symptoms_date %within% study_pd_int)) ~ symptoms_date,
                                  clinic_date %within% study_pd_int ~ clinic_date,
                                  ((is.na(clinic_date) | #if incomplete or 
                                      (clinic_date < eligibility_date)) & # before Aug 19 
                                       (control_visit_date %within% study_pd_int)) ~ control_visit_date,
                                  TRUE ~ as.Date(NA)),
            

    #==== Case ascertainment----
          #  2022-01-18 data call decisions:  
          #      Cases: Use site test result date, and if missing, use self-reported symptoms date
          #      Controls: Use self-report clinic date, if self-reported missing OR before Aug 19th, 
          #                then use the sit- reported clinic date

          
          # Case status categories
           caco_stat_cat = fct_relevel(as_factor(case_when(
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    is.na(index_date)      ~ "Case: invalid date",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    (provider_dx == 0 &
                                                       clinic_yesno == 1) ~ "Case-site, Control-self",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    (provider_dx == 0 &
                                                       clinic_yesno != 1) ~ "Case: self-no dx & clinic visit",
                                                  
                                                  case_yesno %in% c(1,2) & # Site-reported as confirmed or probable case
                                                    provider_dx == 1 &
                                                    !is.na(index_date)     ~ "Case",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    provider_dx == 1     ~ "Control-site, Case-self",
                                                  
                                                 case_yesno == 3 & # Site-reported as confirmed or probable case
                                                    provider_dx != 1 &
                                                    is.na(index_date) ~ "Control: invalid date",
                                                  
                                                  case_yesno == 3 & # Site-reported as control
                                                    clinic_yesno != 1 &
                                                    !is.na(index_date)  ~ "Control: no clinic visit-self",
                                                 
                                                  case_yesno == 3 & # Site-reported as control
                                                   clinic_yesno == 1 &
                                                    #provider_dx != 1 &
                                                    !is.na(index_date)    ~ "Control",
                                                
                                                  
                                                  is.na(case_yesno) ~ "Site-report missing",
                                                  
                                                  TRUE ~ as.character(NA))),
                              "Case", 
                              "Case: invalid date",
                              "Case: self-no dx & clinic visit",
                              "Control",
                              "Control: no clinic visit-self",
                              "Control: invalid date",
                              "Case-site, Control-self",
                              "Control-site, Case-self", 
                              "Site-report missing"),
    
    # binary case status: main analysis
    caco = fct_relevel(as_factor(case_when(caco_stat_cat %in% c("Case",
                                                                "Control-site, Case-self",
                                                                "Case-site, Control-self",
                                                                "Case: self-no dx & clinic visit") ~ "Case",
                                           caco_stat_cat %in% c("Control",
                                                                
                                                                "Control: no clinic visit-self") ~ "Control",
                                           TRUE ~ as.character(NA))),
                       "Case", "Control"),
    
    # binary case status: sensitivity analysis, controls who did not self-report as having clinic visit
    caco_sen = fct_relevel(as_factor(case_when(caco_stat_cat %in% c("Case") ~ "Case",
                                               caco_stat_cat %in% c("Control") ~ "Control",
                                               TRUE ~ as.character(NA))),
                           "Case", "Control"),
    
  # Re assign index dates 
  index_date = case_when((caco_stat_cat == "Control-site, Case-self" &
                                       (symptoms_date %within% study_pd_int)) ~ symptoms_date,
                                     (caco_stat_cat == "Case-site, Control-self" &
                                       (clinic_date %within% study_pd_int)) ~ test_result_date,
                                     !caco_stat_cat %in%c("Control-site, Case-self", "Case-site, Control-self") ~ index_date,
                                     TRUE ~ as.Date(NA)),
  
  index_yrmo = format_ISO8601(index_date, precision = "ym"),
  index_epiyr   = epiyear(index_date),
  index_epiwk   = epiweek(index_date),
  index_epiyrwk_2 = fct_relevel(as_factor(case_when(index_epiyr == 2022 &
                                                                 index_epiwk %in% c(33, 34)~ "2022: 33-34",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(35, 36)~ "2022: 35-36",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(37, 38)~ "2022: 37-38",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(39, 40)~ "2022: 39-40",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(41, 42)~ "2022: 41-42",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(43, 44)~ "2022: 43-44",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(45, 46)~ "2022: 45-46",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(47, 48)~ "2022: 47-48",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(49, 50)~ "2022: 49-50",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(51, 52)~ "2022: 51-52",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(1, 2)  ~  "2023: 1-2",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(3, 4)  ~  "2023: 3-4",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(5, 6)  ~  "2023: 5-6",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(7, 8)  ~  "2023: 7-8",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(9, 10)  ~ "2023: 9-10"))),
  
  index_epiyrwk_4 = fct_relevel(as_factor(case_when(index_epiyr == 2022 &
                                                                 index_epiwk %in% c(33, 34, 35, 36)~ "2022: 33-36",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(37, 38, 39, 40)~ "2022: 37-40",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(41, 42, 43, 44)~ "2022: 41-44",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(45, 46, 47, 48)~ "2022: 45-48",
                                                               index_epiyr == 2022 &
                                                                 index_epiwk %in% c(49, 50, 51, 52)~ "2022: 49-52",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(1, 2, 3, 4)  ~  "2023: 1-4",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(5, 6, 7, 8)  ~  "2023: 5-8",
                                                               index_epiyr == 2023 &
                                                                 index_epiwk %in% c(9, 10, 11, 12)  ~ "2023: 9-12"))),
  
  
  #==== Vaccination Status ----
          
         # address invalid dates for self-reported vaccination dates
         d1_yr = case_when(first_dose_date > redcap_trans_date ~ 2022,
                           year(first_dose_date) == 2021 ~ 2022,
                           first_dose_date < ymd("2022-04-30") ~ 2023,
                           TRUE ~ as.numeric(year(first_dose_date))),
         first_dose_date = make_date(year = d1_yr, month = month(first_dose_date), day = day(first_dose_date)),
               
         d2_yr = case_when(second_dose_date > redcap_trans_date ~ 2022,
                           year(second_dose_date) == 2021 ~ 2022,
                           second_dose_date < ymd("2022-04-30") ~ 2023,
                           TRUE ~ as.numeric(year(second_dose_date))),
         second_dose_date = make_date(year = d2_yr, month = month(second_dose_date), day = day(second_dose_date)),
  
          # Combine site- and self-reported vaccination dose variables
          vax1_yesno = case_when((is.na(dose1_yesno) & !is.na(first_dose_yesno)) |
                                   (dose1_yesno == 0 & first_dose_yesno == 1)      ~ first_dose_yesno,
                           TRUE ~ as.numeric(dose1_yesno)),
          
          vax1_date = case_when((!is.na(first_dose_date) & !is.na(second_dose_date) & is.na(dose2_date)) | 
                                  (is.na(dose1_date) &
                                  first_dose_yesno == 1 & !is.na(first_dose_date)) ~ first_dose_date,
                           TRUE ~ as.Date(dose1_date)),
  
          vax1_yrmo = format_ISO8601(vax1_date, precision = "ym"),
          
          vax2_yesno = case_when((is.na(dose2_yesno) & !is.na(second_dose_yesno)) |
                                   (dose2_yesno == 0 & second_dose_yesno == 1) ~ second_dose_yesno,
                           TRUE ~ as.numeric(dose2_yesno)),
          
          vax2_date = case_when(is.na(dose2_date) &
                                  second_dose_yesno == 1 & !is.na(second_dose_date) ~ second_dose_date,
                           TRUE ~ as.Date(dose2_date)),
          
          vax2_yrmo = format_ISO8601(vax2_date, precision = "ym"),
  
          # Time (days) between index event date and 1st/2nd doses
          dose1index_days = index_date - vax1_date,

          dose2index_days = index_date - vax2_date,
    
          dose_int        = vax2_date - vax1_date,
          
          # Vax status: Site
          vax_stat_na = as.character(NA),
          vax_stat_acip = fct_relevel(as_factor(case_when(!is.na(index_date) & 
                                                            (vax1_yesno == 0 &  # no documented vaccination OR Post index event vax
                                                                 (vax2_yesno == 0 | is.na(vax2_yesno))) ~ "S1",
                                                          vax1_date >= index_date ~ "S2",
                                                          vax1_yesno == 1 &                 
                                                             dose1index_days <= 13    ~ "S3",
                                                          (vax1_yesno == 1 & vax2_yesno != 1 & 
                                                            dose1index_days >= 14)   ~ "S4",
                                                          (vax1_yesno == 1 & vax2_yesno == 1 &  
                                                             dose1index_days >= 14 & dose_int <24) ~ "S5",
                                                          (vax2_yesno == 1 &                 
                                                             dose1index_days >= 14 &          
                                                             dose_int >=24 & dose2index_days < 14) ~ "S6",
                                                     (vax2_yesno == 1 &
                                                        dose_int >=24 & dose2index_days >= 14) ~ "S7",  
                                                     TRUE ~ as.character(vax_stat_na))),
                                 "S1", "S2", "S3", "S4", "S5", "S6", "S7"),
  
        mr_vax_stat_acip = fct_relevel(as_factor(mr_vax_stat_acip), 
                                       "S1", "S2", "S3", "S4", "S5", "S6", "S7"),
        mr_review_vax_stat = fct_relevel(as_factor(mr_scenario_r1), 
                                       "S1", "S2", "S3", "S4", "S5",
                                       "S6", "S7", "Exclude/investigate"),
  
        vax_stat_post_acip = fct_relevel(as_factor(case_when(!is.na(index_date) &
                                                            (vax1_yesno == 0 &  # no documented vaccination OR Post index event vax
                                                                 (vax2_yesno == 0 | is.na(vax2_yesno))) ~ "S1",
                                                          vax1_date >= index_date ~ "S2",
                                                          vax1_yesno == 1 &
                                                             dose1index_days <= 13    ~ "S3",
                                                          ((vax1_yesno == 1 & vax2_yesno != 1 &
                                                            dose1index_days >= 14) |
                                                             (vax2_yesno == 1 &
                                                             dose1index_days >= 14 &
                                                             dose_int >=24 & dose2index_days <= 0))   ~ "S4",
                                                          (vax1_yesno == 1 & vax2_yesno == 1 &
                                                             dose1index_days >= 14 & dose_int <24) ~ "S5",
                                                          (vax2_yesno == 1 &
                                                             dose1index_days >= 14 &
                                                             dose_int >=24 & dose2index_days < 14) ~ "S6",
                                                     (vax2_yesno == 1 &
                                                        dose_int >=24 & dose2index_days >= 14) ~ "S7",
                                                     TRUE ~ as.character(vax_stat_na))),
                                 "S1", "S2", "S3", "S4", "S5", "S6", "S7"),

          vax_stat = fct_relevel(as_factor(case_when(!is.na(index_date) & 
                                                       ((vax1_yesno == 0 &  # no documented vaccination OR Post index event vax
                                                                (vax2_yesno == 0 | is.na(vax2_yesno)))|
                                                          (vax1_date >= index_date)) ~ "Unvaccinated",
                                                     (vax1_yesno == 1 &                   # 1 dose but dose1-index date interval < 14 days
                                                           dose1index_days <= 13)    ~ "PEP",
                                                     ((vax1_yesno == 1 & vax2_yesno != 1 &   # 1 dose partial (1st dose but no 2nd dose)
                                                        dose1index_days >= 14) |
                                                       (vax1_yesno == 1 & vax2_yesno == 1 &  # D1 is <24 days before D2
                                                          dose1index_days >= 14 &          
                                                          dose_int <24) |
                                                       (vax2_yesno == 1 &                  # 2 doses partial
                                                          dose1index_days >= 14 &          # (dose 2-index date interval < 14 days )
                                                          dose_int >=24 & dose2index_days < 14)) ~ "Partially vaccinated",
                                                     (vax2_yesno == 1 &
                                                        dose_int >=24 & dose2index_days >= 14) ~ "Fully vaccinated",  
                                                     TRUE ~ as.character(vax_stat_na))),
                                 "Fully vaccinated", "Partially vaccinated", "PEP", "Unvaccinated"),
    
         # Exclude those who had 2 doses but D1 is <24 days before D2 for VE analysis
         vax_stat_ve = case_when((vax1_yesno == 1 & vax2_yesno == 1 & 
                                 dose1index_days >= 14 & dose_int <24) | # S5: Partial, D1-D2 interval <24d
                                  vax_stat == "PEP" ~ NA_character_,     # S3: PEP, IE based
                                 TRUE ~ as.character(vax_stat)),
  
        vax_stat_ve_acip = case_when((vax1_yesno == 1 & vax2_yesno == 1 & 
                                   dose1index_days >= 14 & dose_int <24) | # S5: Partial, D1-D2 interval <24d
                                  (vax2_yesno == 1 & dose1index_days >= 14 &  
                                     dose_int >=24 & dose2index_days < 14) |   # S6: Partial, D2 <14 before IE,
                                  vax_stat == "PEP" ~ NA_character_,     # S3: PEP, IE based
                                TRUE ~ as.character(vax_stat)),
  
        # Model 1 (main model):
        vax_stat_ve_main = case_when(vax_stat_post_acip %in% c("S1", "S2") ~ "Unvaccinated",
                                     vax_stat_post_acip %in% c("S4", "S6") ~ "Partially vaccinated",
                                     vax_stat_post_acip %in% c("S7") ~ "Fully vaccinated",
                                  TRUE ~ as.character(NA)),
  
        # Sensitivity Model 2 (include S6 as fully vaccinated): 
        vax_stat_ve_s6_full = case_when(vax_stat_post_acip %in% c("S1", "S2") ~ "Unvaccinated",
                                           vax_stat_post_acip %in% c("S4") ~ "Partially vaccinated",
                                           vax_stat_post_acip %in% c("S7", "S6") ~ "Fully vaccinated",
                                        TRUE ~ as.character(NA)),
  
        #Sensitivity Model 3 (exclude S6 all together)
        vax_stat_ve_s6_excl = case_when(vax_stat_post_acip %in% c("S1", "S2") ~ "Unvaccinated",
                                           vax_stat_post_acip %in% c("S4") ~ "Partially vaccinated",
                                           vax_stat_post_acip %in% c("S7") ~ "Fully vaccinated",
                                        TRUE ~ as.character(NA)),
  
         # Post-exposure prophylaxis
          pep_stat_ve = fct_relevel(as_factor(case_when(why_vax___1 == 1 ~ "PEP-Vaccinated",
                                                        vax_stat == "Unvaccinated" ~ "Unvaccinated",
                                                        TRUE ~as.character(NA))),
                                    "PEP-Vaccinated", "Unvaccinated"),
    
    #==== Minimum set variables ----
    # Create indicator vars to help flag records missing minimum set of data elements need for VE  variables
          minset_vars = fct_relevel(as_factor(case_when(is.na(case_yesno) |
                                                          is.na(vax1_yesno) |
                                                          (vax1_yesno == 1 & is.na(vax1_date)) |
                                                          (vax1_yesno == 1 & is.na(vax2_yesno)) |
                                                          (vax2_yesno == 1 & is.na(vax2_date)) |
                                                          (!is.na(control_visit_date) &
                                                             !is.na(test_result_date)) | # MD respondents where site-reported test results and control_visit date are available; they people who had test results before Aug 19 as controls.
                                                          #is.na(provider_dx) |
                                                                 #is.na(clinic_yesno) | 
                                                                 is.na(index_date) ~ "Incomplete",
                                                               TRUE ~ as.character("Complete"))),
                                          "Complete", "Incomplete"),
    #==== DQ Check: Non-vaccination ----
  
        # symptom Onset Date vs Test Date (Cases) - Compare symptom onset date to ensure same day as
        #                                           or before positive test result (cases only)
    
         symp_gt_test_date_f = fct_relevel(as_factor(case_when(caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date >= test_result_date) ~ "Yes",
                                                               caco == "Case" & !is.na(symptoms_date) &
                                                                 !is.na(test_result_date) &
                                                                 (symptoms_date < test_result_date) ~ "No",
                                                               caco == "Control"                     ~ "Not applicable, control",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No", "Not applicable, control"),
        
        # Clinic Visit Date â HD vs Self Report (Controls) - Compare  clinic visit as reported from HD compared to self-report 
        #                                                    Flag if (clinic_date - control_visit_date) > +/- 2
         clinic_v_control_date = fct_relevel(as_factor(case_when(!is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) > 20) ~ "Abs > 20 days: Yes",
                                                                 !is.na(clinic_date) & !is.na(control_visit_date) &
                                                                   (abs(clinic_date - control_visit_date) <= 20) ~ "Abs > 20 days: No",
                                                                 TRUE ~ as.character(NA))),
                                             "Abs > 20 days: Yes", "Abs > 20 days: No"),
    #==== DQ Check: Vaccination variables ----
           
          # Dose 1 and Dose 2 Vaccination Interval (self-report) - Flag interval < 24 days and > 24 days to ID implausible intervals
          dose_int_self = ifelse(!is.na(first_dose_date) & !is.na(second_dose_date), second_dose_date - first_dose_date, NA), 
          dose_int_cat_self = fct_relevel(as_factor(case_when(first_dose_yesno != 1                                   ~ "Not Vaxed",
                                                                !is.na(first_dose_date) & is.na(second_dose_date)    ~ "Dose #1 only",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) < 24)        ~ "<24 days",
                                                             !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  (((second_dose_date - first_dose_date) %in% c(24:28)))  ~ "24-28 days",
                                                                !is.na(first_dose_date) & !is.na(second_dose_date) & 
                                                                  ((second_dose_date - first_dose_date) > 28)            ~ ">28 days",
                                                             TRUE ~ as.character(NA))),
                                       "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"),
           
         
    
          # site-report: Dose 1 and Dose 2 Vaccination Interval - Flag interval < 24 days and > 24 days to ID implausible intervals
         dose_int_site = ifelse(!is.na(dose1_date) & !is.na(dose2_date), dose2_date - dose1_date, NA),
         dose_int_cat_site = fct_relevel(as_factor(case_when(dose1_yesno != 1                             ~ "Not Vaxed",
                                                              !is.na(dose1_date) & is.na(dose2_date)      ~ "Dose #1 only",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) < 24)          ~ "<24 days",
                                                           !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                  (((dose2_date - dose1_date) %in% c(24:28)))  ~ "24-28 days",
                                                              !is.na(dose1_date) & !is.na(dose2_date) & 
                                                                ((dose2_date - dose1_date) > 28)          ~ ">28 days",
                                                           TRUE ~ as.character(NA))),
                                         "Dose #1 only", "<24 days", "24-28 days", ">28 days", "Not Vaxed"
                                                           ),
        # Vaccine Dose Number â HD vs Self Report: Compare number of vaccine doses reported from HD compared to self-report
          site_v_self_dose1 = fct_relevel(as_factor(case_when((dose1_yesno == 1 & first_dose_yesno == 1) |
                                                                (dose1_yesno == 0 & first_dose_yesno == 0) ~ "Same",
                                                              (dose1_yesno == 1 & first_dose_yesno == 0)   ~ "Site-Vax",
                                                              (dose1_yesno == 0 & first_dose_yesno == 1)   ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
          site_v_self_dose2 = fct_relevel(as_factor(case_when((dose2_yesno == 1 & second_dose_yesno == 1) |
                                                                (dose2_yesno == 0 & second_dose_yesno == 0) ~ "Same",
                                                              (dose2_yesno == 1 &
                                                                 (second_dose_yesno == 0 | is.na(second_dose_yesno)))   ~ "Site-Vax",
                                                              ((dose2_yesno == 0 | is.na(dose2_yesno)) &
                                                                 second_dose_yesno == 1)  ~ "Self-Vaxed",
                                                              TRUE ~ as.character(NA))),
                                          "Same", "Site-Vax", "Self-Vaxed"),
    
       # Vaccine Administration Date â HD vs Self Report: Compare dates of vaccination administration between
       #                                                  HD and self-report (add +/- 1 or 2 days)
    
        site_v_self_vaxdate1 = fct_relevel(as_factor(case_when(!is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) > 2) ~ "Abs > 2: Yes",
                                                               !is.na(dose1_date) & !is.na(first_dose_date) &
                                                                 (abs(dose1_date   - first_dose_date) <= 2) ~ "Abs > 2: No",
                                                               TRUE ~ as.character(NA))),
                                         "Abs > 2: Yes", "Abs > 2: No"),
       
       site_v_self_vaxdate2 = fct_relevel(as_factor(case_when(!is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) > 2) ~ "Abs > 2: Yes",
                                                              !is.na(dose2_date) & !is.na(second_dose_date) &
                                                                (abs(dose2_date   - second_dose_date) <= 2) ~ "Abs > 2: No",
                                                              TRUE ~ as.character(NA))),
                                          "Abs > 2: Yes", "Abs > 2: No"),
    # Prior Smallpox Vaccination Timing flag
           smallpox_birth_f = fct_relevel(as_factor(case_when((priorvax == 1 & (birth_year < priorvax_year)|
                                                                priorvax %in% c(2:3)) ~ "Plausible",
                                                              priorvax == 1 & (birth_year > priorvax_year) ~ "Implausible",
                                                              priorvax == 1 & is.na(birth_year) ~ "birth year missing",
                                                              priorvax == 1 & is.na(priorvax_year) ~ "Vax year missing",
                                                            TRUE ~ as.character(NA))),
                                        "Plausible", "Implausible", "birth year missing", "Vax year missing"),

      #==== Clean analysis variables ----
       # Check to make sure birth year is within range of a person being between 18-49 years old
       #               Invalid birth years/ages should be captured via REDCap checks, except for some unusual
       #                situations which should be reviewed and resolved on a case-by-case basis 
              # Calculate age based on birth year and symptom or clinic date
              age = year(index_date) - birth_year,
              # Flag if submitted dateâ birth_year <18 | > 49 (AOD: we do not have submitted date) 
              age_f = fct_relevel(as_factor(case_when(age < 18          ~ "<18",
                                                            age %in% c(18:49) ~ "18-49",
                                                            age > 49          ~ "\u226550",
                                                            TRUE ~ as.character(NA))),
                                        "<18", "18-49", "\u226550"),
              # Age categorical
              age_cat = fct_relevel(as_factor(case_when(age %in% c(18:29) ~ "18-29",
                                                        age %in% c(30:39) ~ "30-39",
                                                        age >=40 ~ "40-49",
                                                            TRUE ~ as.character(NA))),
                                        "18-29", "30-39", "40-49"),
  
          
    
           #categorical race variable
            race_cat = fct_relevel(as_factor(case_when((race___1 == 1 & race___2 == 0 & race___3 == 0 &
                                                         race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "African American or Black",
                                                       (race___1 == 0 & race___2 == 1 & race___3 == 0 &
                                                         race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "White",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 1 &
                                                          race___4 == 0 & race___5 == 0 & race___6 == 0) ~ "Asian",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 1 & race___5 == 0 & race___6 == 0) ~ "Native Hawaiin/Pacific Islander",
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 0 & race___5 == 1 & race___6 == 0) ~ "American Indian/Alaska Native", 
                                                       (race___1 == 0 & race___2 == 0 & race___3 == 0 &
                                                          race___4 == 0 & race___5 == 0 & race___6 == 1) ~ "Prefer not to answer",
                                                       (race___1 == 1 | race___2 == 1 | race___3 == 1 |
                                                          race___4 == 1 | race___5 == 1 | race___6 == 1) ~ "Multiracial",
                                                       TRUE ~ NA_character_)), 
                                   "African American or Black", "White", "Asian",
                                   "Native Hawaiin/Pacific Islander", "American Indian/Alaska Native", "Prefer not to answer",
                                   "Multiracial"),


            #race-ethnicity: ethnicity (1, Hispanic or Latino | 2, Not Hispanic or Latino | 3, Prefer not to answer)
            race_ethn_cat = fct_relevel(as_factor(case_when(ethnicity == 1 ~ "Hispanic",
                                                        race_cat == "White" ~ "White",
                                                        race_cat == "African American or Black" ~ "Black",
                                                        race_cat == "Asian" ~ "Asian",
                                                        race_cat == "Native Hawaiin/Pacific Islander" ~ "Native Hawaiin/Pacific Islander",
                                                        race_cat == "American Indian/Alaska Native" ~ "American Indian/Alaska Native",
                                                        race_cat == "Multiracial" ~ "Multiracial",
                                                        
                                                        TRUE ~ as.character("Other"))),
                                        "Black", "White", "Hispanic", "Asian",
                                   "Native Hawaiin/Pacific Islander", "American Indian/Alaska Native", "Multiracial", "Other"),
  
            race_ethn = fct_relevel(as_factor(case_when(ethnicity == 1 ~ "Hispanic",
                                                        race_cat == "White" ~ "White",
                                                        race_cat == "African American or Black" ~ "Black",
                                                        TRUE ~ as.character("Other"))),
                                        "Black", "White", "Hispanic", "Other"),
  
  
  
  # Length of Hospitalization - Examine if length of days of hospitalization is longer than
          #                             the time between illness onset and survey submission
          #                             Flag if hospitalized_days > (submitted date - symptoms_date)
          #!                            AOD: We do not have a submitted date variable at CDC as the sites
          #!                                are not uploading the time stamps. However, only 2 people reported
          #!                                being hospitalized and their days of hospitalization (3 & 13) seem plausible.
         hospitalized_cat = fct_relevel(as_factor(case_when(hospitalized == 0 ~ "No",
                                                            hospitalized == 1 ~ "Yes",
                                                            TRUE ~ as.character(NA))),
                                        "Yes", "No"),
         hospitalized_days_cat = fct_relevel(as_factor(case_when(hospitalized_days == 0         ~ "0",
                                                                  hospitalized_days %in% c(1:7)   ~ "1-7",
                                                                  hospitalized_days %in% c(8:14)  ~ "8-14",
                                                                  hospitalized_days %in% c(15:21) ~ "15-21",
                                                                  hospitalized_days %in% c(22:28) ~ "22-28",
                                                                  hospitalized_days >= 29         ~ "\u226529",
                                                                  TRUE ~ as.character(NA))),
                                              "0", "1-7","8-14", "15-21", "22-28", "22-28", "\u226529"),
    
          # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #           AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls                    #                                categorization included below.
          
        immunocompromised = fct_relevel(as_factor(case_when(hiv_status == 1 | immune_response ==  1 ~ "Yes",
                                                            TRUE ~ as.character("No"))),
                                        "Yes", "No"),
    # Number of sexual partners - Examine distribution of number of sexual partners for any implausible values
          #                   AOD: what would be considered implausible values?  Range: 0-15 for cases; 0-20 for controls                     
          sex_part_num = ifelse(caco == "Case", sex_part_num_case, 
                               ifelse(caco == "Control", sex_part_num_control, NA)),
          sex_part_num_cat = fct_relevel(as_factor(case_when(sex_part_num == 0 ~ "0",
                                                            sex_part_num == 1 ~ "1",
                                                            sex_part_num == 2 ~ "2",
                                                            sex_part_num == 3 ~ "3",
                                                            sex_part_num >= 4 ~ "\u22654",
                                                            TRUE ~ as.character(NA))),
                                         "0", "1", "2", "3", "\u22654"),
          sex_part_num_mod = fct_relevel(as_factor(case_when(sex_part_num == 0 ~ "0",
                                                            sex_part_num == 1 ~ "1",
                                                            sex_part_num == 2 ~ "2",
                                                            sex_part_num == 3 ~ "3",
                                                            sex_part_num >= 4 ~ "\u22654",
                                                            TRUE ~ as.character("missing"))),
                                         "0", "1", "2", "3", "\u22654", "missing"),
      
           
      
    # Flag those who reported having experienced mpox symptoms and specified one of the listed symptoms 
             symptom_type_complete = ifelse(symptoms_yesno == 1 &
                                                 if_any(contains("symptom_type___"), ~ . == 1),
                                               1,
                                               ifelse(symptoms_yesno == 1 &
                                                         if_all(contains("symptom_type___"), ~ . == 0),
                                                       0, NA)),

      # Mpox exposure history: contacts
  
      close_contact_dx_og = case_when(caco == "Case" & !is.na(contact_mpx_dx_case) ~ contact_mpx_dx_case,
                                     caco == "Case" & 
                                       (is.na(contact_mpx_dx_case) & 
                                          !is.na(contact_mpx_dx_control)) ~ contact_mpx_dx_control,
                                     caco == "Control" & !is.na(contact_mpx_dx_control) ~ contact_mpx_dx_control,
                                     caco == "Control" & 
                                       (is.na(contact_mpx_dx_control) & 
                                          !is.na(contact_mpx_dx_case)) ~ contact_mpx_dx_case,
                                     TRUE ~ as.numeric(NA)),
  
      close_contact_dx_cat_og = fct_relevel(as_factor(case_when(close_contact_dx_og == 1 ~ "Yes",
                                                             close_contact_dx_og == 2 ~ "No",
                                                             close_contact_dx_og == 3 ~ "Don't know",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No","Don't know"),
  
  
        close_contact_dx = case_when(caco == "Case" & !is.na(contact_mpx_dx_case) ~ contact_mpx_dx_case,
                                     caco == "Case" & 
                                       (is.na(contact_mpx_dx_case) & 
                                          !is.na(contact_mpx_dx_control)) ~ contact_mpx_dx_control,
                                     caco == "Control" & !is.na(contact_mpx_dx_control) ~ contact_mpx_dx_control,
                                     caco == "Control" & 
                                       (is.na(contact_mpx_dx_control) & 
                                          !is.na(contact_mpx_dx_case)) ~ contact_mpx_dx_case,
                                     TRUE ~ as.numeric(3)),
  
      close_contact_dx_cat = fct_relevel(as_factor(case_when(close_contact_dx == 1 ~ "Yes",
                                                             close_contact_dx == 2 ~ "No",
                                                             close_contact_dx == 3 ~ "Don't know",
                                                             TRUE ~ as.character(NA))),
                                         "Yes", "No","Don't know"),
  elig_gender_cat = fct_relevel(as_factor(case_when(elig_gender == 1 ~ "Male",
                                                                 elig_gender == 2 ~ "Female",
                                                                 elig_gender == 3 ~ "Transgender male",
                                                                 elig_gender == 4 ~ "Transgender female",
                                                                 elig_gender == 5 ~ "Another gender identity",
                                                                 TRUE ~ as.character(NA))),
                                             "Male", "Female", "Transgender male", "Transgender female",
                                             "Another gender identity"),
               health_ins_cat = fct_relevel(as_factor(case_when(health_ins == 1 ~ "Public",
                                                                health_ins == 2 ~ "Private",
                                                                health_ins == 3 ~ "Public & private",
                                                                health_ins == 4 ~ "None",
                                                                health_ins == 5 ~ "Don't know",
                                                                 TRUE ~ as.character(NA))),
                                             "Public", "Private", "Public & private", "None","Don't know"),
               housing_cat = fct_relevel(as_factor(case_when(homeless == 1 ~ "Homeless shelter",
                                                             homeless == 2 ~ "Unsheltered",
                                                             homeless == 3 ~ "No",
                                                             homeless == 4 ~ "Prefer not to answer",
                                                                 TRUE ~ as.character(NA))),
                                             "Homeless shelter", "Unsheltered", "No", "Prefer not to answer"),
               hiv_status_cat = fct_relevel(as_factor(case_when(hiv_status == 1 ~ "Living with HIV",
                                                                hiv_status == 2 ~ "Not living with HIV",
                                                                hiv_status == 3 ~ "Don't know",
                                                                hiv_status == 4 ~ "Prefer not to answer",
                                                                TRUE ~ as.character(NA))),
                                             "Living with HIV", "Not living with HIV", "Don't know", "Prefer not to answer"),
               hiv_cd4_cat = fct_relevel(as_factor(case_when(hiv_cd4 == 1 ~ "<200",
                                                                hiv_cd4 == 2 ~ "200-500",
                                                                hiv_cd4 == 3 ~ ">500",
                                                                hiv_cd4 == 4 ~ "Don't know",
                                                                hiv_cd4 == 5 ~ "Don't know",
                                                                 TRUE ~ as.character(NA))),
                                         "<200", "200-500", ">500", "Don't know", "Prefer not to answer"),
               hiv_prep_cat = fct_relevel(as_factor(case_when(hiv_prep == 1 ~ "Yes",
                                                                hiv_prep == 2 ~ "No",
                                                                hiv_prep == 3 ~ "Don't know",
                                                                TRUE ~ as.character(NA))),
                                             "Yes", "No", "Don't know"),
               sex_work_cat = fct_relevel(as_factor(case_when(sex_work == 1 ~ "Yes",
                                                                sex_work == 2 ~ "No",
                                                                sex_work == 3 ~ "Don't know",
                                                                TRUE ~ as.character(NA))),
                                             "Yes", "No", "Don't know")
  
      # time period matching
      # close ------
       
            ) %>% 
        # select(-redcap_trans_date) %>% 
        # mutate(
        #        
        #        valid_dates = case_when(if_any(c(vax1_date, vax2_date, index_date,)ends_with("_date"),  ~ .x >= ymd("2023-03-06")) ~ 0,
        #                                TRUE ~ as.numeric(1))
        #        )%>% 
  select(pid, jid, everything(), -redcap_data_access_group)

# checks ----------
     
      
```

### Distribution of complete minimum set of data elements

**Table 1. Distribution of respondents with a minimum set of data elements**

```{r}
mpoxve %>% 
  #filter(!is.na(caco_stat_cat)) %>% 
  select(jid, minset_vars) %>% 
  tbl_summary(
    by = jid,
    label = list(minset_vars ~ "Min data elements")
    
  )  %>% 
  add_n() %>% 
  add_overall() %>% 
  bold_labels()

```

**Figure 1. Missingness patterns across a the set of minimum data elements**

```{r}
mpoxve %>% 
  filter(jid == "NYC") %>%
  pfreq(consent)
  
  
mpoxve %>% 
  filter(jid == "NYC") %>% 
  select(case_yesno, index_date, vax1_yesno, vax1_date, vax2_yesno, vax2_date)%>%
  gg_miss_upset()

```

### Distribution of case status

**Figure 2. Case definition**

![](screenshots/case_def_2023-03-10.png)

## **Vaccination status: post-manual review comparison**

**Table 1. comparison of manual review and coded scenarios**

```{r}
mpoxve %>%
  filter(minset_vars == "Complete" & mr == 1) %>%
  select(caco, mr_vax_stat_acip, mr_review_vax_stat, vax_stat_post_acip,
         vax_stat_ve_main) %>%
  tbl_summary(
    by = caco,
    label = list(mr_vax_stat_acip ~ "Scenerios: ACIP",
                 mr_review_vax_stat ~ "Scenerios: manual review",
                 vax_stat_post_acip ~ "Scenarios: coded",
                 vax_stat_ve_main ~ "Vax status: M1\U1d43"),
    #missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels() %>% 
  as_gt()%>%
  gt::tab_source_note(gt::md("Senario Definitions"))%>%
  gt::tab_source_note(gt::md("  S1: 0 doses"))%>%
  gt::tab_source_note(gt::md("  S2: D1 is on OR after IE"))%>%
  gt::tab_source_note(gt::md("  S3: D1 is 1â¤ 13 d before IE"))%>%
  gt::tab_source_note(gt::md("  S4: D1 is > 13 d before IE"))%>%
  gt::tab_source_note(gt::md("  S5: D1 is > 13 d before IE & D1 is < 24 d before D2"))%>%
  gt::tab_source_note(gt::md("  S6: D1 is > 13 d before IE & D1 is â¥ 24 d before D2 & D2 is â¤ 13 d before IE"))%>%
  gt::tab_source_note(gt::md("  S7: D1 is > 13 d before IE & D1 is â¥ 24 d before D2 & D2 is > 13 d before IE"))%>%
  gt::tab_source_note(gt::md("\U1d43 Based on coded vax status: Unvaccinated (S1 & S2), Partial (S4 & S6), Fully (S7) and  missing (S3 & S5)."))

```

## **Descriptive Statistics**

**Table 2. Distribution of variables under consideration in the models by case status**

```{r}
mpoxve %>%
  filter(minset_vars == "Complete") %>%
  select(caco, age_cat, race_ethn_cat, race_ethn, immunocompromised, sex_part_num_cat, sex_part_num_mod,
         close_contact_dx_cat_og, close_contact_dx_cat, vax_stat_post_acip, vax_stat_ve_main, vax_stat_ve_s6_full, vax_stat_ve_s6_excl) %>%
  tbl_summary(
    by = caco,
    label = list(age_cat ~ "Age categories",
                 race_ethn_cat ~ "Ethnicity, race",
                 race_ethn ~ "Ethnicity, race: Model",
                 immunocompromised ~ "Immunocompromised",
                 sex_part_num_cat ~ "Number of sexual partners\U1d43",
                 sex_part_num_mod ~ "Number of sexual partners: model",
                 close_contact_dx_cat_og ~ "Close contact w/mpox case: Original \U1d47",
                 close_contact_dx_cat ~ "Close contact w/mpox case: ACIP model\U1d9c",
                 vax_stat_post_acip ~ "Scenarios: coded"
                 vax_stat_ve_main ~ "Vax status: M1\U1d48",
                 vax_stat_ve_s6_full ~ "Vax status: M2-S6 full\U1d48",
                 vax_stat_ve_s6_excl ~ "Vax status: M3-S6 excl\U1d49"),
    #missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels() %>% 
  as_gt()%>%
  gt::tab_source_note(gt::md("\U1d43 The missingness is high for the variable because it was not required"))%>%
  gt::tab_source_note(gt::md("\U1d47 Missing is among respondents who were recruited as controls but did not report a clinic visit, which means that they did not have the opportunity to answer this question. I used the site-reported clinic visit for their index date.")) %>%
  gt::tab_source_note(gt::md("\U1d9c Those who were missing this values were code as 'Don't know.' We did this for the ACIP analysis after we noticed the level of missingness for the number of sexual partners variable to maximize the number of respondent included in the model." )) %>%
  gt::tab_source_note(gt::md("\U1d48 Missing represent scenarios 3 and 5."))%>%
  gt::tab_source_note(gt::md("\U1d49 Missing represent scenarios 3, 5 and 6."))

```

**Table 3. Participant characteristics by case status**

```{r}
mpoxve %>%
  filter(minset_vars == "Complete") %>%
  select(caco, jid, age_cat, race_ethn_cat, elig_gender_cat, health_ins_cat,
         housing_cat, sex_work_cat, hiv_status_cat, hiv_cd4_cat, hiv_prep_cat,
         immunocompromised, close_contact_dx_cat, sex_part_num_cat) %>%
  tbl_summary(
    by = caco,
    label = list(jid ~ "Jurisdiction",
                 age_cat ~ "Age categories\U1d43",
                 race_ethn_cat ~ "Ethnicity, race\U1d47",
                 elig_gender_cat ~ "Gender",
                 health_ins_cat ~ "Insurance Status",
                 housing_cat ~ "Experienced homelessness in past 3 weeks",
                 sex_work_cat ~ "Transactional sex",
                 hiv_status_cat ~ "HIV status",
                 hiv_cd4_cat ~ "CD4 count\U1d9c",
                 hiv_prep_cat ~ "HIV PrEP\U1d48",
                 immunocompromised ~ "Immunocompromised\U1d49",
                 sex_part_num_cat ~ "Number of sexual partners",
                 close_contact_dx_cat ~ "Close contact w/mpox case"),
    #missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels() %>%
  as_gt()%>%
  gt::tab_source_note(gt::md("\U1d43 Missing is from TN_99, which has 2022 as the birth year."))%>%
  gt::tab_source_note(gt::md("\U1d47 Hispanic includes self-reported as Hispanic regardless of race.")) %>%
  gt::tab_source_note(gt::md("\U1d9c Denominator is those living with HIV." )) %>%
  gt::tab_source_note(gt::md("\U1d48 Denominator is Those who report anything other than living with HIV."))%>%
  gt::tab_source_note(gt::md("\U1d49 HIV or any medical condition other than HIV that weakens your immune response, or use of medicine (other than for HIV) that weakens immune response"))

```

**Table 4. Participant characteristics by vaccination status (M1)**

```{r}
mpoxve %>%
  filter(minset_vars == "Complete") %>%
  select(vax_stat_ve_main, jid, age_cat, race_ethn_cat, elig_gender_cat, health_ins_cat,
         housing_cat, sex_work_cat, hiv_status_cat, hiv_cd4_cat, hiv_prep_cat,
         immunocompromised, close_contact_dx_cat, sex_part_num_cat) %>%
  tbl_summary(
    by = vax_stat_ve_main,
    label = list(jid ~ "Jurisdiction",
                 age_cat ~ "Age categories\U1d43",
                 race_ethn_cat ~ "Ethnicity, race\U1d47",
                 elig_gender_cat ~ "Gender",
                 health_ins_cat ~ "Insurance Status",
                 housing_cat ~ "Experienced homelessness in past 3 weeks",
                 sex_work_cat ~ "Transactional sex",
                 hiv_status_cat ~ "HIV status",
                 hiv_cd4_cat ~ "CD4 count\U1d9c",
                 hiv_prep_cat ~ "HIV PrEP\U1d48",
                 immunocompromised ~ "Immunocompromised\U1d49",
                 sex_part_num_cat ~ "Number of sexual partners",
                 close_contact_dx_cat ~ "Close contact w/mpox case"),
    #missing = "always",
    missing_text = "Missing"

  )  %>%
  add_n() %>%
  add_overall() %>%
  bold_labels() %>%
  as_gt()%>%
  gt::tab_source_note(gt::md("\U1d43 Missing is from TN_99, which has 2022 as the birth year."))%>%
  gt::tab_source_note(gt::md("\U1d47 Hispanic includes self-reported as Hispanic regardless of race.")) %>%
  gt::tab_source_note(gt::md("\U1d9c Denominator is those living with HIV." )) %>%
  gt::tab_source_note(gt::md("\U1d48 Denominator is Those who report anything other than living with HIV."))%>%
  gt::tab_source_note(gt::md("\U1d49 HIV or any medical condition other than HIV that weakens your immune response, or use of medicine (other than for HIV) that weakens immune response"))

```

**Figure 1. Distribution of index event dates**

If there a better we way to operationalize the 4-week time period? Should we recode it differently?

```{r}

 mpoxve_ie_counts <- mpoxve %>%
  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%
  drop_na(caco, vax_stat_ve_main, age, age_cat, race_ethn, immunocompromised, sex_part_num_mod,
          close_contact_dx_cat) %>%
  mutate(n_count = 1) %>%
  group_by(jid, caco, vax_stat_ve_main, vax_stat_post_acip, index_date) %>% 
  summarise(across(c(n_count), sum, na.rm = TRUE))
  
  epi_counts_obj_day <- incidence(              # create weekly incidence object
    mpoxve_ie_counts,                         # dataset with counts aggregated by week
    date_index = index_date,  # column with dates
    count = n_count,                    # column with counts
    interval = "day"                  # aggregate daily counts up to weeks
    #groups = surv_tot,                   # group by hospital
  ) 
  
plot(epi_counts_obj_day)

epi_counts_obj_wk <- incidence(              # create weekly incidence object
    mpoxve_ie_counts,                         # dataset with counts aggregated by week
    date_index = index_date,  # column with dates
    count = n_count,                    # column with counts
    interval = "week"                  # aggregate daily counts up to weeks
    #groups = surv_tot,                   # group by hospital
  ) 
  
plot(epi_counts_obj_wk)
  
```


**Table 5. Study participant characteristics by case status (complete data in model 1)**

If there a better we way to operationalize the 4-week time period? Should we recode it differently?

```{r}

mpoxve %>%

  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%

  drop_na(caco, vax_stat_ve_main, age, age_cat, race_ethn, immunocompromised, sex_part_num_mod,  close_contact_dx_cat, index_epiyrwk_4, index_epiyrwk_2, index_yrmo) %>%

  select(caco, vax_stat_ve_main, age_cat, race_ethn, immunocompromised,

         close_contact_dx_cat, index_epiyrwk_4, index_epiyrwk_2, index_yrmo) %>%

  tbl_summary(

    by = caco,

    label = list(age_cat ~ "Age categories",

                 race_ethn ~ "Ethnicity, race",

                 immunocompromised ~ "Immunocompromised",

                 close_contact_dx_cat ~ "Close contact mpox case*",
                 index_epiyrwk_4 ~ "4-week time period",
                 index_epiyrwk_2 ~ "2-week time period (not in models)",
                 index_yrmo ~ "Month time period (not in models)",
                 vax_stat_ve_main ~ "Vaccination status**"),

    #missing = "always",

    missing_text = "Missing"

  )  %>%

  add_n() %>%

  add_overall() %>%

  bold_labels() %>%

  as_gt()%>%

  gt::tab_source_note(gt::md("*Three weeks before diagnosis (case) or clinic visit (controls)."))%>%

  gt::tab_source_note(gt::md("**Missing represent scenarios 3, 5, & 6."))

```

## **Adjusted Models**

```{r}

analysis <- mpoxve %>%
  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%
  filter(index_date <= ymd("2022-11-26")) %>% 
  drop_na(caco, vax_stat_ve_main, age, age_cat, race_ethn, immunocompromised,
         close_contact_dx_cat) %>%
  mutate(caco = fct_rev(caco),
         vax_stat_ve_main = fct_rev(vax_stat_ve_main),
         vax_stat_ve_s6_full = fct_rev(vax_stat_ve_s6_full),
         vax_stat_ve_s6_excl = fct_rev(vax_stat_ve_s6_excl))

mod1_unadj <- glmer(formula = caco ~ vax_stat_ve_main +
                    (1 | jid),
                 family = binomial(link = "logit"),
                 control = glmerControl(optimizer = "bobyqa"),
                 data = analysis)

mod1_unadj_age_race_immu <- glmer(formula = caco ~ vax_stat_ve_main + 
                                    age + race_ethn +  immunocompromised + 
                                    (1 | jid),
                                  family = binomial(link = "logit"),
                                  control = glmerControl(optimizer = "bobyqa"),
                                  data = analysis)

mod1_adj_contact <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +
                            close_contact_dx_cat +
                            (1 | jid),
                          family = binomial(link = "logit"),
                          control = glmerControl(optimizer = "bobyqa"),
                          data = analysis)

mod1_spline <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +
                       close_contact_dx_cat + 
                       ns(index_date, knots= c(ymd("2022-09-15"), ymd("2022-10-15")))+
                       (1 | jid),
                     family = binomial(link = "logit"),
                     control = glmerControl(optimizer = "bobyqa"),
                     data = analysis)

mod1_s6f_spline <- glmer(formula = caco ~ vax_stat_ve_s6_full + age + race_ethn +  immunocompromised +
                       close_contact_dx_cat + 
                       ns(index_date, knots= c(ymd("2022-09-15"), ymd("2022-10-15")))+
                       (1 | jid),
                     family = binomial(link = "logit"),
                     control = glmerControl(optimizer = "bobyqa"),
                     data = analysis)

tab_model(mod1_unadj, mod1_adj, mod1_s6f_spline, show.aic = T, show.obs = T)

```
**Model 1: main model crude and adjusted without time period**

```{r}

analysis <- mpoxve %>%
  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%
  filter(index_date <= ymd("2022-11-26")) %>% 
  drop_na(caco, vax_stat_ve_main, age, age_cat, race_ethn, immunocompromised,
         close_contact_dx_cat) %>%
  mutate(caco = fct_rev(caco),
         vax_stat_ve_main = fct_rev(vax_stat_ve_main),
         vax_stat_ve_s6_full = fct_rev(vax_stat_ve_s6_full),
         vax_stat_ve_s6_excl = fct_rev(vax_stat_ve_s6_excl))

mod1_unadj <- glmer(formula = caco ~ vax_stat_ve_main +
                    (1 | jid),
                 family = binomial(link = "logit"),
                 control = glmerControl(optimizer = "bobyqa"),
                 data = analysis)

mod1_unadj_age_race_immu <- glmer(formula = caco ~ vax_stat_ve_main + 
                                    age + race_ethn +  immunocompromised + 
                                    (1 | jid),
                                  family = binomial(link = "logit"),
                                  control = glmerControl(optimizer = "bobyqa"),
                                  data = analysis)

mod1_adj_contact <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +
                            close_contact_dx_cat +
                            (1 | jid),
                          family = binomial(link = "logit"),
                          control = glmerControl(optimizer = "bobyqa"),
                          data = analysis)

mod1_spline <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +
                       close_contact_dx_cat + 
                       ns(index_date, knots= c(ymd("2022-09-15"), ymd("2022-10-15")))+
                       (1 | jid),
                     family = binomial(link = "logit"),
                     control = glmerControl(optimizer = "bobyqa"),
                     data = analysis)

tab_model(mod1_unadj, mod1_adj, mod1_spline, show.aic = T, show.obs = T)

```

**Model 1: main model (close contacts only)**

As you can see, the partially vaccinated have higher VE than the fully vaccinated. The 4-week time period variable is have a major influence on the results.

```{r}

analysis <- mpoxve %>%

  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%

  drop_na(caco, vax_stat_ve_main, age, age_cat, race_ethn, immunocompromised,

         close_contact_dx_cat , index_epiyrwk_2
         ) %>%

  mutate(caco = fct_rev(caco),

         vax_stat_ve_main = fct_rev(vax_stat_ve_main))

mod1_adj <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +

                    close_contact_dx_cat + index_epiyrwk_2 + 
                    (1 | jid),

                 family = binomial(link = "logit"),

                 control = glmerControl(optimizer = "bobyqa"),

                 data = analysis)

tab_model(mod1_adj,  show.aic = T, show.obs = T)

```

**Model 1: main model (Splines - knots: "2022-09-11" and "2022-10-09")**

```{r}


mod1_adj <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn +  immunocompromised +
                    close_contact_dx_cat + 
                    ns(index_date, knots= c(ymd("2022-09-11"), ymd("2022-10-09")))+
                    (1 | jid),

                 family = binomial(link = "logit"),

                 control = glmerControl(optimizer = "bobyqa"),

                 data = analysis)

tab_model(mod1_adj,  show.aic = T, show.obs = T)

```

**Model 2: S6 included as full**

```{r}

analysis <- mpoxve %>%

  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%

  drop_na(caco, vax_stat_ve_s6_full, age, age_cat, race_ethn, immunocompromised,

         close_contact_dx_cat , index_epiyrwk_4
         ) %>%

  mutate(caco = fct_rev(caco),

         )

mod1_adj <- glmer(formula = caco ~ vax_stat_ve_s6_full + age + race_ethn +  immunocompromised +

                    close_contact_dx_cat + index_epiyrwk_4 + 
                    (1 | jid),

                 family = binomial(link = "logit"),

                 control = glmerControl(optimizer = "bobyqa"),

                 data = analysis)

tab_model(mod1_adj,  show.aic = T, show.obs = T)

```

**Model 3: S6 excluded**

```{r}

analysis <- mpoxve %>%

  filter(minset_vars == "Complete" & !jid %in% c("CA", "NYC", "DC")) %>%

  drop_na(caco, vax_stat_ve_s6_excl, age, age_cat, race_ethn, immunocompromised,

         close_contact_dx_cat, index_epiyrwk_4) %>%

  mutate(caco = fct_rev(caco),

         )

mod1_adj <- glmer(formula = caco ~ vax_stat_ve_s6_excl + age + race_ethn +  immunocompromised +

                    close_contact_dx_cat + index_epiyrwk_4 + (1 | jid),

                 family = binomial(link = "logit"),

                 control = glmerControl(optimizer = "bobyqa"),

                 data = analysis)

tab_model(mod1_adj,  show.aic = T, show.obs = T)

```

<!-- **IC-Yes (left-side OR), IC-No (right-side OR)** -->

<!-- ```{r} -->

<!-- analysis_ic_yes <- analysis %>% -->

<!--   filter(immunocompromised == "Yes") -->

<!-- analysis_ic_no <- analysis %>% -->

<!--   filter(immunocompromised == "No") -->

<!-- mod1_adj_ic_yes <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn + -->

<!--                            close_contact_dx_cat + index_epiyrwk_4 + (1 | jid), -->

<!--                          family = binomial(link = "logit"), -->

<!--                          control = glmerControl(optimizer = "bobyqa"), -->

<!--                          data = analysis_ic_yes) -->

<!-- mod1_adj_ic_no <- glmer(formula = caco ~ vax_stat_ve_main + age + race_ethn + -->

<!--                           close_contact_dx_cat + index_epiyrwk_4 + (1 | jid), -->

<!--                         family = binomial(link = "logit"), -->

<!--                         control = glmerControl(optimizer = "bobyqa"), -->

<!--                         data = analysis_ic_no) -->

<!-- tab_model(mod1_adj_ic_yes, mod1_adj_ic_no, show.aic = T, show.obs = T) -->

<!-- ``` -->

<!-- ## -->
